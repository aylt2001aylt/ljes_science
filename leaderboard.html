<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬é©—æˆç¸¾æ’è¡Œæ¦œ</title>
    <!-- è¼‰å…¥ Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Lucide Icons --><script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* å­—å‹å»ºè­°ï¼šNoto Sans TC / Inter */
        html { font-family: 'Inter', 'Noto Sans TC', sans-serif; }

        /* è‡ªå®šç¾©é¡è‰²è®Šæ•¸ */
        :root {
            --color-bg-secondary: #ecfdf5; /* æ·ºç¶  (Emerald-50) */
            --color-main: #10b981; /* ä¸»ç¶ è‰² (Emerald-500) */
        }

        body {
            background-color: var(--color-bg-secondary);
            color: #1f2937;
            padding-bottom: 4rem;
        }

        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 1.5rem;
        }

        .main-button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            background-color: var(--color-main);
            color: white;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.4);
            transition: all 0.2s;
        }

        .main-button:hover {
            background-color: #059669; /* Emerald-600 */
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(16, 185, 129, 0.5);
        }

        .keyword-btn {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 200ms;
            cursor: pointer;
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            color: #1f2937;
        }
        .keyword-btn.selected {
            background-color: var(--color-main);
            color: white;
            border-color: var(--color-main);
        }
        
        /* æ’è¡Œæ¦œåˆ†æ•¸æ¢æ¨£å¼ */
        .score-bar {
            background-color: var(--color-main);
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease-out;
            min-width: 2%; /* ç¢ºä¿ 0 åˆ†æ™‚ä¹Ÿèƒ½çœ‹åˆ°ä¸€å°æ¢ */
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- 1ï¸âƒ£ é ‚éƒ¨å€å¡Š -->
    <header class="bg-white sticky top-0 z-10 shadow-md py-4 mb-8">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 flex items-center">
                <i data-lucide="trophy" class="inline-block w-8 h-8 mr-2 text-yellow-500"></i>
                æ¸¬é©—æˆç¸¾æ’è¡Œæ¦œ
            </h1>
            <p class="mt-2 text-base sm:text-lg text-gray-600 border-b pb-3 border-gray-100">
                åœ°è³ªå°å°ˆå®¶æŒ‘æˆ°æˆæœï¼Œå¯ä»¥é»æ“ŠæŒ‰éˆ•ä¾†åˆ‡æ›æ’åºã€‚
            </p>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <section class="card space-y-6">
            
            <!-- æ’åºé¸æ“‡ -->
            <div class="flex items-center space-x-4 border-b pb-4 border-gray-100">
                <span class="font-semibold text-gray-700">æ’åºæ–¹å¼:</span>
                <button id="sort-score-btn" class="keyword-btn selected">
                    <i data-lucide="star" class="w-4 h-4 mr-1"></i>
                    ä¾åˆ†æ•¸é«˜ä½
                </button>
                <button id="sort-name-btn" class="keyword-btn">
                    <i data-lucide="user" class="w-4 h-4 mr-1"></i>
                    ä¾åå­—ç­†åŠƒ/å­—æ¯
                </button>
            </div>

            <!-- æ’è¡Œæ¦œåˆ—è¡¨ -->
            <div id="leaderboard-list" class="space-y-3">
                <!-- Leaderboard items injected by JS -->
                <div id="loading-message" class="text-center text-lg text-gray-500 py-4">
                    <i data-lucide="loader" class="w-6 h-6 animate-spin mr-2 inline-block"></i>
                    é€£ç·šåˆ°æ’è¡Œæ¦œä¸¦è¼‰å…¥æˆç¸¾ä¸­...
                </div>
            </div>
            
            <p id="empty-leaderboard-msg" class="text-center text-lg text-gray-500 py-4 hidden">
                ç›®å‰é‚„æ²’æœ‰æˆç¸¾ï¼Œè¶•å¿«å» <a href="index.html" class="text-emerald-500 font-semibold hover:underline">é–‹å§‹æ¸¬é©—</a> å§ï¼
            </p>

            <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                <!-- èª¿æ•´æ¸…é™¤æŒ‰éˆ•ä»¥è§¸ç™¼å¯†ç¢¼ Modal -->
                <button id="clear-leaderboard-btn" class="px-4 py-2 text-sm font-medium text-red-500 hover:text-red-700 transition-colors">
                    <i data-lucide="trash-2" class="w-4 h-4 mr-1 inline-block"></i>
                    æ¸…é™¤æ‰€æœ‰ç´€éŒ„
                </button>
                <a href="index.html" class="main-button flex items-center">
                    <i data-lucide="arrow-left" class="w-5 h-5 mr-2 inline-block"></i>
                    è¿”å›æ¸¬é©—ä¸»é 
                </a>
            </div>
        </section>
    </main>
    
    <!-- å¯†ç¢¼é©—è­‰ Modal è¦–çª— -->
    <div id="password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden transition-opacity">
        <div class="card w-full max-w-sm relative">
            <h3 class="text-xl font-bold mb-4 text-red-600 flex items-center">
                <i data-lucide="lock" class="w-5 h-5 mr-2"></i>
                éœ€è¦ç®¡ç†å“¡å¯†ç¢¼
            </h3>
            <p class="text-gray-600 mb-4">è«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¢ºèªæ¸…é™¤æ‰€æœ‰æ’è¡Œæ¦œç´€éŒ„ã€‚</p>

            <input type="password" id="password-input" placeholder="å¯†ç¢¼" class="w-full p-3 mb-4 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-colors">
            
            <p id="password-error" class="text-red-500 text-sm mb-4 hidden">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚</p>

            <div class="flex justify-end space-x-3">
                <button id="cancel-clear-btn" class="px-4 py-2 text-sm font-medium text-gray-500 hover:bg-gray-100 rounded-lg">
                    å–æ¶ˆ
                </button>
                <button id="confirm-clear-btn" class="px-4 py-2 text-sm font-medium main-button bg-red-500 hover:bg-red-600 shadow-md shadow-red-300">
                    ç¢ºèªæ¸…é™¤
                </button>
            </div>
        </div>
    </div>


    <!-- é å°¾ï¼ˆFooterï¼‰ -->
    <footer class="mt-10 py-4 border-t border-gray-200 text-center text-gray-500 text-sm bg-white shadow-inner">
        <p>Â© 2025 å°ç£å²©çŸ³èˆ‡ç¤¦ç‰©å°å¹«æ‰‹ | æ’è¡Œæ¦œ</p>
    </footer>

    <!-- ä¿®æ­£å¾Œçš„å–®ä¸€æ¨¡çµ„è…³æœ¬ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // ä¿®æ­£åŒ¯å…¥æ–¹å¼ï¼šç›´æ¥åŒ¯å…¥ serverTimestamp å’Œ Timestamp
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, onSnapshot, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ----------------------------------------------------
        // --- å…¨å±€ Firebase è®Šæ•¸èˆ‡åˆå§‹åŒ– ---
        // ----------------------------------------------------
        // â­ æ–°å¢ï¼šæ‚¨çš„è‡ªå®šç¾© Firebase é…ç½®ç‰©ä»¶
        const CUSTOM_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBobNJrmek6HcBRrgmaFEeoWX7P-mPTLUQ",
            authDomain: "empyrean-kit-478605-s8.firebaseapp.com",
            projectId: "empyrean-kit-478605-s8",
            storageBucket: "empyrean-kit-478605-s8.firebasestorage.app",
            messagingSenderId: "266858477654",
            appId: "1:266858477654:web:9c1e4c12819a51ca6c63f7"
        };
        
        // æª¢æŸ¥ä¸¦åˆå§‹åŒ– Firebase è®Šæ•¸
        const appId = CUSTOM_FIREBASE_CONFIG.projectId; // â­ ä¿®æ­£ï¼šä½¿ç”¨è‡ªå®šç¾©é…ç½®çš„ projectId ä½œç‚º appId
        
        // â­ ä¿®æ­£ï¼šç›´æ¥ä½¿ç”¨è‡ªå®šç¾©é…ç½®
        const firebaseConfig = CUSTOM_FIREBASE_CONFIG;
        
        // ç”±æ–¼æˆ‘å€‘ä½¿ç”¨è‡ªå®šç¾©é…ç½®ï¼Œé€™è£¡çš„ initialAuthToken ä»ç„¶æœƒå¾ç’°å¢ƒè®Šæ•¸ä¸­å–å¾—
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Firestore Collection Path (å…¬å…±è³‡æ–™)
        // ä¿®æ­£ï¼šä½¿ç”¨è‡ªå®šç¾© appId å»ºç«‹è·¯å¾‘
        const COLLECTION_PATH = `artifacts/${appId}/public/data/leaderboard_scores`;

        let app, db, auth;
        let userId;
        let isAuthReady = false;

        // ç°¡åŒ– firebase_firestore ç‰©ä»¶ï¼Œç›´æ¥ä½¿ç”¨åŒ¯å…¥çš„å‡½å¼
        const firebase_firestore = { 
            serverTimestamp: serverTimestamp,
            Timestamp: Timestamp
        };


        /** åˆå§‹åŒ– Firebase æ‡‰ç”¨ç¨‹å¼å’Œèº«ä»½é©—è­‰ */
        async function initFirebaseAndAuth() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                $loadingMsg.textContent = "åˆå§‹åŒ–éŒ¯èª¤ï¼šFirebase é…ç½®éºå¤±ã€‚";
                return false;
            }

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // â­ ä¿®æ­£ï¼šæ–°å¢å®¹éŒ¯æ©Ÿåˆ¶ï¼Œå³ä½¿ Auth å¤±æ•—ï¼Œä¹Ÿå…è¨±é€£æ¥ Firestore
            try {
                // åŸ·è¡ŒåŒ¿åç™»å…¥
                await signInAnonymously(auth);
                console.log("Firebase Auth using Anonymous Sign-In successful.");
                userId = auth.currentUser?.uid; // ç™»å…¥æˆåŠŸï¼Œä½¿ç”¨ Firebase UID
            } catch (error) {
                // å¦‚æœåŒ¿åç™»å…¥å¤±æ•— (auth/configuration-not-found)
                console.error("FATAL: Firebase Authentication failed (Anonymous Sign-In Error):", error);
                
                // â­ FALLBACK: å³ä½¿ Auth å¤±æ•—ï¼Œä¹Ÿè¦å˜—è©¦é€£æ¥ Firestoreã€‚
                // å‰µå»ºä¸€å€‹æœ¬åœ° UUID ä½œç‚º userIdï¼Œé€™æ¨£ Firestore è·¯å¾‘ä»ç„¶æœ‰æ•ˆã€‚
                userId = crypto.randomUUID(); 
                isAuthReady = true; // è¨­ç½®ç‚º Readyï¼Œå…è¨± Firestore é‚è¼¯åŸ·è¡Œ
                $loadingMsg.textContent = `èªè­‰å¤±æ•— (auth/configuration-not-found)ã€‚å°‡ä½¿ç”¨æœ¬åœ° ID: ${userId} ç¹¼çºŒé€£æ¥ Firestoreã€‚è«‹ç¢ºèª Firebase å°ˆæ¡ˆå·²å•Ÿç”¨ã€ŒåŒ¿åç™»å…¥ã€ï¼`;
                
                // è¿”å› trueï¼Œè®“ä¸»ç¨‹å¼å¯ä»¥ç¹¼çºŒåŸ·è¡Œ Firestore ç›¸é—œçš„é‚è¼¯
                return true; 
            }

            // æˆåŠŸç™»å…¥çš„è·¯å¾‘
            isAuthReady = true;
            console.log("Firebase Auth Ready. User ID:", userId);
            return true;
        }
        
        // ----------------------------------------------------
        // --- æ‡‰ç”¨ç¨‹å¼é‚è¼¯ ---
        // ----------------------------------------------------

        // DOM å…ƒç´ å¿«å–
        const $leaderboardList = document.getElementById('leaderboard-list');
        const $emptyLeaderboardMsg = document.getElementById('empty-leaderboard-msg');
        const $loadingMsg = document.getElementById('loading-message');
        const $sortScoreBtn = document.getElementById('sort-score-btn');
        const $sortNameBtn = document.getElementById('sort-name-btn');
        const $clearLeaderboardBtn = document.getElementById('clear-leaderboard-btn');
        
        // å¯†ç¢¼ Modal å…ƒç´ 
        const $passwordModal = document.getElementById('password-modal');
        const $passwordInput = document.getElementById('password-input');
        const $passwordError = document.getElementById('password-error');
        const $confirmClearBtn = document.getElementById('confirm-clear-btn');
        const $cancelClearBtn = document.getElementById('cancel-clear-btn');
        
        // ç‹€æ…‹
        let leaderboardSortKey = 'score'; // 'score' æˆ– 'name'
        let allScores = []; // å„²å­˜å¾ Firestore è¼‰å…¥çš„æ‰€æœ‰åˆ†æ•¸
        
        // å¯†ç¢¼å¸¸æ•¸
        const ADMIN_PASSWORD = 'aylt2001aylt';
        let unsubscribe = null;
        let latestEntryId = null;

        /** è§£æ URL åƒæ•¸ */
        function getUrlParams() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const regex = /([^&=]+)=([^&]*)/g;
            let m;
            while (m = regex.exec(queryString)) {
                params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
            }
            return params;
        }

        /** * è™•ç†æ–°åˆ†æ•¸ä¸¦å„²å­˜åˆ° Firestoreã€‚*/
        async function processNewScore(params) {
            if (!isAuthReady) {
                console.warn("Firebase Auth not ready, skipping score submission.");
                return null;
            }

            if (params.name && params.score && !isNaN(parseInt(params.score))) {
                const newEntry = { 
                    name: params.name, 
                    score: parseInt(params.score), 
                    date: new Date().toLocaleDateString('zh-TW'),
                    userId: userId, // å„²å­˜ä½¿ç”¨è€… ID (å¯èƒ½ç‚º Firebase UID æˆ–æœ¬åœ° UUID)
                    // ä¿®æ­£ï¼šç›´æ¥å‘¼å«ç°¡åŒ–å¾Œçš„ firebase_firestore.serverTimestamp()
                    timestamp: firebase_firestore.serverTimestamp() 
                };
                
                try {
                    // 1. æ–°å¢åˆ†æ•¸
                    const docRef = await addDoc(collection(db, COLLECTION_PATH), newEntry);
                    console.log("New score added with ID: ", docRef.id);
                    
                    // ç‚ºäº†ç¢ºä¿æœ¬åœ°è³‡æ–™æœ‰ IDï¼Œæˆ‘å€‘è¿”å›é€™å€‹ç‰©ä»¶
                    return { id: docRef.id, ...newEntry };
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
            }
            return null;
        }
        
        /** ä¿®å‰ªåˆ†æ•¸åˆ—è¡¨ï¼šåƒ…ä¿ç•™å‰ 100 ç­†æœ€é«˜åˆ† */
        async function pruneScores(scores) {
            const MAX_SCORES = 100;
            if (scores.length <= MAX_SCORES) return;

            // æ‰¾å‡ºè¦åˆªé™¤çš„æœ€ä½åˆ†æ–‡ä»¶ï¼ˆç¬¬ 101 ç­†åŠä»¥å¾Œçš„ï¼‰
            // scores é™£åˆ—å·²ç¶“æ˜¯åˆ†æ•¸é«˜->ä½æ’åºï¼Œæ‰€ä»¥æœ€å¾Œçš„å…ƒç´ å°±æ˜¯æœ€ä½åˆ†çš„
            const docsToDelete = scores.slice(MAX_SCORES);
            
            console.log(`Pruning ${docsToDelete.length} low scores.`);

            // åŸ·è¡Œåˆªé™¤æ“ä½œ
            for (const docEntry of docsToDelete) {
                try {
                    // ä½¿ç”¨ document çš„ ID ä¾†åˆªé™¤æ–‡ä»¶
                    await deleteDoc(doc(db, COLLECTION_PATH, docEntry.id));
                } catch (e) {
                    console.error(`Error deleting score ${docEntry.id}:`, e);
                }
            }
        }


        /** æ¸²æŸ“æ’è¡Œæ¦œ */
        function renderLeaderboard(scoresData, highlightId = null) {
            // è¤‡è£½ä¸€ä»½è³‡æ–™é€²è¡Œæ’åº
            let scores = [...scoresData];
            
            // æ’åºé‚è¼¯ (åˆ†æ•¸é«˜->ä½ï¼ŒåŒåˆ†è€…ä¾æ™‚é–“æˆ³èˆŠ->æ–°ï¼Œç¢ºä¿ç©©å®šåæ¬¡)
            scores.sort((a, b) => {
                // ä¸»è¦ä¾æ“šï¼šåˆ†æ•¸é«˜ä½
                if (b.score !== a.score) return b.score - a.score;
                
                // æ¬¡è¦ä¾æ“šï¼šæ™‚é–“æˆ³èˆŠ->æ–° (è¼ƒæ—©ç´€éŒ„è€…å„ªå…ˆ)
                // ä¿®æ­£ï¼šTimestamp å‡½å¼ç‰©ä»¶çš„ now() æ–¹æ³•ï¼Œç¢ºä¿åœ¨æ²’æœ‰æ•¸æ“šæ™‚ä¹Ÿèƒ½æ¯”è¼ƒ
                const tsA = a.timestamp?.toMillis() || firebase_firestore.Timestamp.now().toMillis();
                const tsB = b.timestamp?.toMillis() || firebase_firestore.Timestamp.now().toMillis();
                
                return tsA - tsB; // æ•¸å­—è¶Šå°ï¼ˆè¶Šæ—©ï¼‰ï¼Œè¶Šæ’å‰é¢
            });
            
            // é¡¯ç¤ºå‰ 100 å
            const topScores = scores.slice(0, 100);

            $leaderboardList.innerHTML = '';
            $loadingMsg.classList.add('hidden');
            
            if (topScores.length === 0) {
                $emptyLeaderboardMsg.classList.remove('hidden');
                return;
            }
            $emptyLeaderboardMsg.classList.add('hidden');
            
            // é‡æ–°æ‡‰ç”¨ç•¶å‰çš„æ’åºéµ (åå­—æ’åº)
            if (leaderboardSortKey === 'name') {
                 // localeCompare æœƒä¾æ“šä¸­æ–‡ç­†åŠƒæˆ–å­—æ¯é †åºæ’åº
                 topScores.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW', { sensitivity: 'base' }));
            }

            topScores.forEach((entry, index) => {
                const rank = index + 1;
                let rankText = rank;
                let rankColor = 'text-gray-500';
                
                if (rank === 1) {
                    rankText = 'ğŸ¥‡';
                    rankColor = 'text-yellow-500';
                } else if (rank === 2) {
                    rankText = 'ğŸ¥ˆ';
                    rankColor = 'text-gray-400';
                } else if (rank === 3) {
                    rankText = 'ğŸ¥‰';
                    rankColor = 'text-amber-700';
                }
                
                // åˆ¤æ–·æ˜¯å¦ç‚ºæœ¬æ¬¡æäº¤çš„æˆç¸¾ (ä½¿ç”¨ Firestore ID)
                const isLatest = highlightId !== null && entry.id === highlightId;
                const scorePercent = entry.score; // åˆ†æ•¸å°±æ˜¯ç™¾åˆ†æ¯”

                const item = document.createElement('div');
                item.className = `flex flex-col p-4 border rounded-lg shadow-md transition-all ${isLatest ? 'bg-yellow-50 border-yellow-400 scale-[1.02] ring-2 ring-yellow-500' : 'bg-white border-gray-100'}`;
                item.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl font-black ${rankColor}">${rankText}</span>
                            <span class="text-xl font-bold text-gray-800">${entry.name} ${isLatest ? 'â­' : ''}</span>
                        </div>
                        <span class="text-3xl font-extrabold text-emerald-600">${entry.score} <span class="text-lg font-normal">åˆ†</span></span>
                    </div>
                    <!-- åˆ†æ•¸æ¢ -->
                    <div class="w-full bg-gray-100 h-2 rounded-md overflow-hidden">
                        <div class="score-bar" style="width: ${scorePercent}%;"></div>
                    </div>
                    <p class="text-xs text-right ${isLatest ? 'text-yellow-700' : 'text-gray-400'} mt-1">æ—¥æœŸï¼š${entry.date}</p>
                    <!-- é¡¯ç¤º User ID æ–¹ä¾¿é™¤éŒ¯å’Œè­˜åˆ¥ -->
                    <p class="text-xs text-left text-gray-300 mt-1">User ID: ${entry.userId || 'N/A'}</p>
                `;
                $leaderboardList.appendChild(item);
            });
            
            lucide.createIcons();
            
            // æ¯æ¬¡æ¸²æŸ“å®Œç•¢å¾Œï¼ŒåŸ·è¡Œä¿®å‰ªé‚è¼¯ (ç¢ºä¿æ•¸æ“šåº«å¤§å°å¯æ§)
            // ç”±æ–¼ scores å·²ç¶“æ˜¯å®Œæ•´çš„ä¸”æ’éåºçš„ï¼Œå‚³å…¥å®ƒå¯ä»¥åŸ·è¡Œä¿®å‰ª
            pruneScores(scores);
        }
        
        /** å•Ÿå‹• Firestore ç›£è½å™¨ */
        async function startLeaderboardListener() {
            if (!isAuthReady) return;
            
            // 1. è™•ç† URL ä¸­çš„æ–°åˆ†æ•¸ (å„²å­˜)
            const params = getUrlParams();
            // æª¢æŸ¥ URL ä¸­æ˜¯å¦æœ‰æ–°åˆ†æ•¸ï¼Œå¦‚æœæœ‰ï¼Œå‰‡åŠ å…¥ä¸¦å„²å­˜
            if (params.name && params.score) {
                const newEntry = await processNewScore(params);
                if (newEntry) {
                    latestEntryId = newEntry.id;
                    // æ¸…é™¤ URL åƒæ•¸ï¼Œé¿å…é‡æ–°æ•´ç†æ™‚é‡è¤‡å„²å­˜
                    try {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } catch (e) {
                        console.warn("ç„¡æ³•æ›¿æ›æ­·å²ç‹€æ…‹ (replaceState):", e);
                    }
                }
            }

            // 2. å•Ÿå‹• Firestore å¯¦æ™‚ç›£è½ (onSnapshot)
            if (unsubscribe) unsubscribe();

            const q = query(collection(db, COLLECTION_PATH));
            
            unsubscribe = onSnapshot(q, (querySnapshot) => {
                allScores = [];
                querySnapshot.forEach((docRef) => {
                    const data = docRef.data();
                    // ç¢ºä¿ timestamp æ¬„ä½å­˜åœ¨
                    if (!data.timestamp) {
                        // å¦‚æœç¼ºå¤±ï¼Œçµ¦äºˆä¸€å€‹ç•¶å‰æ™‚é–“
                        data.timestamp = firebase_firestore.Timestamp.now();
                    }
                    allScores.push({ id: docRef.id, ...data });
                });
                
                // ä½¿ç”¨è¼‰å…¥çš„æ•¸æ“šé€²è¡Œæ¸²æŸ“
                renderLeaderboard(allScores, latestEntryId);
                // æ¸²æŸ“å¾Œæ¸…é™¤ latestEntryIdï¼Œé¿å…æ’åºåˆ‡æ›æ™‚é«˜äº®éŒ¯èª¤
                latestEntryId = null;
            }, (error) => {
                console.error("Error listening to leaderboard: ", error);
                $loadingMsg.textContent = "è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–æ¬Šé™ã€‚";
            });
        }
        
        /** é¡¯ç¤ºå¯†ç¢¼ Modal */
        function showClearPasswordModal() {
            $passwordInput.value = '';
            $passwordError.classList.add('hidden');
            $passwordModal.classList.remove('hidden');
            $passwordInput.focus();
        }

        /** å–æ¶ˆæ¸…é™¤ */
        function cancelClear() {
            $passwordModal.classList.add('hidden');
        }
        
        /** å¯†ç¢¼é©—è­‰é‚è¼¯ (Firestore åˆªé™¤) */
        async function verifyPasswordAndClear() {
            if (!isAuthReady) return;

            const enteredPassword = $passwordInput.value.trim();
            $passwordError.classList.add('hidden');
            
            if (enteredPassword === ADMIN_PASSWORD) {
                // é©—è­‰æˆåŠŸï¼ŒåŸ·è¡Œæ¸…é™¤æ“ä½œ
                $loadingMsg.classList.remove('hidden');
                $loadingMsg.textContent = "æ­£åœ¨æ¸…é™¤æ‰€æœ‰ç´€éŒ„...";

                try {
                    // ç²å–æ‰€æœ‰æ–‡ä»¶ ID
                    const snapshot = await getDocs(query(collection(db, COLLECTION_PATH)));
                    
                    // åŸ·è¡Œåˆªé™¤
                    const deletePromises = [];
                    snapshot.forEach((docRef) => {
                        deletePromises.push(deleteDoc(doc(db, COLLECTION_PATH, docRef.id)));
                    });
                    
                    await Promise.all(deletePromises);
                    
                    // éš±è— Modal
                    $passwordModal.classList.add('hidden');
                    
                    console.log("All scores successfully cleared from Firestore.");

                } catch (e) {
                    console.error("Error clearing scores:", e);
                    $passwordError.textContent = `æ¸…é™¤å¤±æ•—: ${e.message}`;
                    $passwordError.classList.remove('hidden');
                }

            } else {
                // é©—è­‰å¤±æ•—
                $passwordError.textContent = "å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚";
                $passwordError.classList.remove('hidden');
                $passwordInput.focus();
            }
        }
        
        // --- åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½å™¨ ---
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. åˆå§‹åŒ– Firebase å’Œèº«ä»½é©—è­‰
            const isReady = await initFirebaseAndAuth();
            
            if (isReady) {
                // 2. å•Ÿå‹•æ’è¡Œæ¦œæ•¸æ“šç›£è½
                startLeaderboardListener();
            } else {
                // å¦‚æœèªè­‰å¤±æ•—ï¼ŒéŒ¯èª¤è¨Šæ¯å·²åœ¨ initFirebaseAndAuth å…§éƒ¨æ›´æ–°
                console.error("Authentication failed. Cannot start leaderboard listener.");
            }

            // 3. ç¶å®šæ’åºäº‹ä»¶
            $sortScoreBtn.addEventListener('click', () => {
                leaderboardSortKey = 'score';
                $sortScoreBtn.classList.add('selected');
                $sortNameBtn.classList.remove('selected');
                renderLeaderboard(allScores);
            });
            $sortNameBtn.addEventListener('click', () => {
                leaderboardSortKey = 'name';
                $sortNameBtn.classList.add('selected');
                $sortScoreBtn.classList.remove('selected');
                renderLeaderboard(allScores);
            });

            // 4. ç¶å®šæ¸…é™¤äº‹ä»¶ (è§¸ç™¼å¯†ç¢¼ Modal)
            $clearLeaderboardBtn.addEventListener('click', showClearPasswordModal);
            
            // 5. ç¶å®šå¯†ç¢¼ Modal äº‹ä»¶
            $cancelClearBtn.addEventListener('click', cancelClear);
            $confirmClearBtn.addEventListener('click', verifyPasswordAndClear);
            
            // å…è¨±åœ¨å¯†ç¢¼è¼¸å…¥æ¡†æŒ‰ Enter éµç¢ºèª
            $passwordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    verifyPasswordAndClear();
                }
            });

            lucide.createIcons(); // ç¢ºä¿æ‰€æœ‰ icon éƒ½è¢«æ¸²æŸ“
        });
    </script>
</body>
</html>
