<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬é©—æˆç¸¾æ’è¡Œæ¦œ</title>
    <!-- è¼‰å…¥ Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Lucide Icons --><script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- å¼•å…¥ Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // æª¢æŸ¥ä¸¦åˆå§‹åŒ– Firebase è®Šæ•¸
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Firestore Collection Path (å…¬å…±è³‡æ–™)
        window.COLLECTION_PATH = `artifacts/${appId}/public/data/leaderboard_scores`;

        if (firebaseConfig) {
            window.app = initializeApp(firebaseConfig);
            window.db = getFirestore(window.app);
            window.auth = getAuth(window.app);
        }

        async function initFirebaseAndAuth() {
            if (!window.auth || !window.db) {
                console.error("Firebase is not initialized.");
                return false;
            }
            
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
                window.userId = window.auth.currentUser?.uid || crypto.randomUUID();
                window.isAuthReady = true;
                console.log("Firebase Auth Ready. User ID:", window.userId);
                return true;
            } catch (error) {
                console.error("Firebase Authentication failed:", error);
                return false;
            }
        }

        // å°‡é€™äº›åˆå§‹åŒ–å‡½æ•¸æš´éœ²çµ¦å…¨å±€ç¯„åœï¼Œä»¥ä¾¿å¾ŒçºŒè…³æœ¬ä½¿ç”¨
        window.initFirebaseAndAuth = initFirebaseAndAuth;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.query = query;
        window.onSnapshot = onSnapshot;

    </script>

    <style>
        /* å­—å‹å»ºè­°ï¼šNoto Sans TC / Inter */
        html { font-family: 'Inter', 'Noto Sans TC', sans-serif; }

        /* è‡ªå®šç¾©é¡è‰²è®Šæ•¸ */
        :root {
            --color-bg-secondary: #ecfdf5; /* æ·ºç¶  (Emerald-50) */
            --color-main: #10b981; /* ä¸»ç¶ è‰² (Emerald-500) */
        }

        body {
            background-color: var(--color-bg-secondary);
            color: #1f2937;
            padding-bottom: 4rem;
        }

        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 1.5rem;
        }

        .main-button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            background-color: var(--color-main);
            color: white;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.4);
            transition: all 0.2s;
        }

        .main-button:hover {
            background-color: #059669; /* Emerald-600 */
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(16, 185, 129, 0.5);
        }

        .keyword-btn {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 200ms;
            cursor: pointer;
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            color: #1f2937;
        }
        .keyword-btn.selected {
            background-color: var(--color-main);
            color: white;
            border-color: var(--color-main);
        }
        
        /* æ’è¡Œæ¦œåˆ†æ•¸æ¢æ¨£å¼ */
        .score-bar {
            background-color: var(--color-main);
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease-out;
            min-width: 2%; /* ç¢ºä¿ 0 åˆ†æ™‚ä¹Ÿèƒ½çœ‹åˆ°ä¸€å°æ¢ */
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- 1ï¸âƒ£ é ‚éƒ¨å€å¡Š -->
    <header class="bg-white sticky top-0 z-10 shadow-md py-4 mb-8">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 flex items-center">
                <i data-lucide="trophy" class="inline-block w-8 h-8 mr-2 text-yellow-500"></i>
                æ¸¬é©—æˆç¸¾æ’è¡Œæ¦œ
            </h1>
            <p class="mt-2 text-base sm:text-lg text-gray-600 border-b pb-3 border-gray-100">
                åœ°è³ªå°å°ˆå®¶æŒ‘æˆ°æˆæœï¼Œå¯ä»¥é»æ“ŠæŒ‰éˆ•ä¾†åˆ‡æ›æ’åºã€‚
            </p>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <section class="card space-y-6">
            
            <!-- æ’åºé¸æ“‡ -->
            <div class="flex items-center space-x-4 border-b pb-4 border-gray-100">
                <span class="font-semibold text-gray-700">æ’åºæ–¹å¼:</span>
                <button id="sort-score-btn" class="keyword-btn selected">
                    <i data-lucide="star" class="w-4 h-4 mr-1"></i>
                    ä¾åˆ†æ•¸é«˜ä½
                </button>
                <button id="sort-name-btn" class="keyword-btn">
                    <i data-lucide="user" class="w-4 h-4 mr-1"></i>
                    ä¾åå­—ç­†åŠƒ/å­—æ¯
                </button>
            </div>

            <!-- æ’è¡Œæ¦œåˆ—è¡¨ -->
            <div id="leaderboard-list" class="space-y-3">
                <!-- Leaderboard items injected by JS -->
                <div id="loading-message" class="text-center text-lg text-gray-500 py-4">
                    <i data-lucide="loader" class="w-6 h-6 animate-spin mr-2 inline-block"></i>
                    é€£ç·šåˆ°æ’è¡Œæ¦œä¸¦è¼‰å…¥æˆç¸¾ä¸­...
                </div>
            </div>
            
            <p id="empty-leaderboard-msg" class="text-center text-lg text-gray-500 py-4 hidden">
                ç›®å‰é‚„æ²’æœ‰æˆç¸¾ï¼Œè¶•å¿«å» <a href="index.html" class="text-emerald-500 font-semibold hover:underline">é–‹å§‹æ¸¬é©—</a> å§ï¼
            </p>

            <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                <!-- èª¿æ•´æ¸…é™¤æŒ‰éˆ•ä»¥è§¸ç™¼å¯†ç¢¼ Modal -->
                <button id="clear-leaderboard-btn" class="px-4 py-2 text-sm font-medium text-red-500 hover:text-red-700 transition-colors">
                    <i data-lucide="trash-2" class="w-4 h-4 mr-1 inline-block"></i>
                    æ¸…é™¤æ‰€æœ‰ç´€éŒ„
                </button>
                <a href="index.html" class="main-button flex items-center">
                    <i data-lucide="arrow-left" class="w-5 h-5 mr-2 inline-block"></i>
                    è¿”å›æ¸¬é©—ä¸»é 
                </a>
            </div>
        </section>
    </main>
    
    <!-- å¯†ç¢¼é©—è­‰ Modal è¦–çª— -->
    <div id="password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden transition-opacity">
        <div class="card w-full max-w-sm relative">
            <h3 class="text-xl font-bold mb-4 text-red-600 flex items-center">
                <i data-lucide="lock" class="w-5 h-5 mr-2"></i>
                éœ€è¦ç®¡ç†å“¡å¯†ç¢¼
            </h3>
            <p class="text-gray-600 mb-4">è«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¢ºèªæ¸…é™¤æ‰€æœ‰æ’è¡Œæ¦œç´€éŒ„ã€‚</p>

            <input type="password" id="password-input" placeholder="å¯†ç¢¼" class="w-full p-3 mb-4 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-colors">
            
            <p id="password-error" class="text-red-500 text-sm mb-4 hidden">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚</p>

            <div class="flex justify-end space-x-3">
                <button id="cancel-clear-btn" class="px-4 py-2 text-sm font-medium text-gray-500 hover:bg-gray-100 rounded-lg">
                    å–æ¶ˆ
                </button>
                <button id="confirm-clear-btn" class="px-4 py-2 text-sm font-medium main-button bg-red-500 hover:bg-red-600 shadow-md shadow-red-300">
                    ç¢ºèªæ¸…é™¤
                </button>
            </div>
        </div>
    </div>


    <!-- é å°¾ï¼ˆFooterï¼‰ -->
    <footer class="mt-10 py-4 border-t border-gray-200 text-center text-gray-500 text-sm bg-white shadow-inner">
        <p>Â© 2025 å°ç£å²©çŸ³èˆ‡ç¤¦ç‰©å°å¹«æ‰‹ | æ’è¡Œæ¦œ</p>
    </footer>

    <script>
        // DOM å…ƒç´ å¿«å–
        const $leaderboardList = document.getElementById('leaderboard-list');
        const $emptyLeaderboardMsg = document.getElementById('empty-leaderboard-msg');
        const $loadingMsg = document.getElementById('loading-message');
        const $sortScoreBtn = document.getElementById('sort-score-btn');
        const $sortNameBtn = document.getElementById('sort-name-btn');
        const $clearLeaderboardBtn = document.getElementById('clear-leaderboard-btn');
        
        // å¯†ç¢¼ Modal å…ƒç´ 
        const $passwordModal = document.getElementById('password-modal');
        const $passwordInput = document.getElementById('password-input');
        const $passwordError = document.getElementById('password-error');
        const $confirmClearBtn = document.getElementById('confirm-clear-btn');
        const $cancelClearBtn = document.getElementById('cancel-clear-btn');
        
        // ç‹€æ…‹
        let leaderboardSortKey = 'score'; // 'score' æˆ– 'name'
        let allScores = []; // å„²å­˜å¾ Firestore è¼‰å…¥çš„æ‰€æœ‰åˆ†æ•¸
        
        // å¯†ç¢¼å¸¸æ•¸
        const ADMIN_PASSWORD = 'aylt2001aylt';
        // const MAX_SCORES = 100; // æœ€å¤šä¿ç•™ 100 ç­†è³‡æ–™

        /** è§£æ URL åƒæ•¸ */
        function getUrlParams() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const regex = /([^&=]+)=([^&]*)/g;
            let m;
            while (m = regex.exec(queryString)) {
                params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
            }
            return params;
        }

        /** * è™•ç†æ–°åˆ†æ•¸ä¸¦å„²å­˜åˆ° Firestoreã€‚
         * ç‚ºäº†ä¿æŒå‰ 100 åçš„é™åˆ¶ï¼ˆå› ç‚ºä¸èƒ½ä½¿ç”¨ orderBy/limit çµ„åˆï¼‰ï¼Œ
         * æˆ‘å€‘å°‡æ–°åˆ†æ•¸åŠ å…¥ï¼Œä¸¦åŸ·è¡Œä¸€å€‹ã€Œä¿®å‰ªã€å‹•ä½œï¼Œåˆªé™¤æ’åæœ€ä½çš„ç´€éŒ„ã€‚
         */
        async function processNewScore(params) {
            if (!window.isAuthReady) {
                console.warn("Firebase Auth not ready, skipping score submission.");
                return null;
            }

            if (params.name && params.score && !isNaN(parseInt(params.score))) {
                const newEntry = { 
                    name: params.name, 
                    score: parseInt(params.score), 
                    date: new Date().toLocaleDateString('zh-TW'),
                    timestamp: window.firebase.firestore.FieldValue.serverTimestamp() // ç‚ºäº†åœ¨åŒåˆ†æ™‚ä¿æŒå…ˆå¾Œé †åº
                };
                
                try {
                    // 1. æ–°å¢åˆ†æ•¸
                    const docRef = await window.addDoc(window.collection(window.db, window.COLLECTION_PATH), newEntry);
                    console.log("New score added with ID: ", docRef.id);

                    // 2. ç²å–æ‰€æœ‰åˆ†æ•¸é€²è¡Œæ’åºå’Œä¿®å‰ª (ç¢ºä¿åªä¿ç•™æœ€é«˜åˆ†çš„å‰ N ç­†)
                    // æ³¨æ„ï¼šç”±æ–¼ onSnapshot å·²ç¶“å•Ÿå‹•ï¼Œé€™è£¡åªè™•ç†æ–°å¢ï¼Œä¿®å‰ªå°‡ç”± onSnapshot è§¸ç™¼å¾ŒåŸ·è¡Œã€‚
                    
                    return { id: docRef.id, ...newEntry };
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
            }
            return null;
        }
        
        /** ä¿®å‰ªåˆ†æ•¸åˆ—è¡¨ï¼šåƒ…ä¿ç•™å‰ 100 ç­†æœ€é«˜åˆ† */
        async function pruneScores(scores) {
            const MAX_SCORES = 100;
            if (scores.length <= MAX_SCORES) return;

            // 1. æ ¹æ“šåˆ†æ•¸å’Œæ™‚é–“æˆ³ï¼ˆç”¨æ–¼ç©©å®šæ€§ï¼‰æ’åºï¼Œç¢ºä¿æœ€ä½åˆ†åœ¨æœ€å¾Œ
            // scores é™£åˆ—å·²ç¶“æ˜¯æ’åºå¥½çš„ç‹€æ…‹ (score DESC, id ASC)
            
            // 2. æ‰¾å‡ºè¦åˆªé™¤çš„æœ€ä½åˆ†æ–‡ä»¶
            const docsToDelete = scores.slice(MAX_SCORES);
            
            console.log(`Pruning ${docsToDelete.length} low scores.`);

            // 3. åŸ·è¡Œåˆªé™¤æ“ä½œ
            for (const doc of docsToDelete) {
                try {
                    await window.deleteDoc(window.doc(window.db, window.COLLECTION_PATH, doc.id));
                } catch (e) {
                    console.error(`Error deleting score ${doc.id}:`, e);
                }
            }
        }


        /** æ¸²æŸ“æ’è¡Œæ¦œ */
        function renderLeaderboard(scoresData, latestEntryId = null) {
            // è¤‡è£½ä¸€ä»½è³‡æ–™é€²è¡Œæ’åºå’Œä¿®å‰ª
            let scores = [...scoresData];
            
            // æ’åºé‚è¼¯ (åˆ†æ•¸é«˜->ä½ï¼ŒåŒåˆ†è€…ä¾æ™‚é–“æˆ³æ–°->èˆŠ)
            scores.sort((a, b) => {
                // ä¸»è¦ä¾æ“šï¼šåˆ†æ•¸é«˜ä½
                if (b.score !== a.score) return b.score - a.score;
                
                // æ¬¡è¦ä¾æ“šï¼šæ™‚é–“æˆ³æ–°èˆŠ
                // Firestore timestampç‰©ä»¶éœ€è¦è½‰æ›æˆæ•¸å­—æ‰èƒ½æ¯”è¼ƒ
                const tsA = a.timestamp?.toMillis() || 0;
                const tsB = b.timestamp?.toMillis() || 0;
                
                // å¦‚æœæ˜¯æ–°ç´€éŒ„ï¼Œid æ˜¯ä¸€å€‹æ•¸å­—ï¼ˆDate.now()ï¼‰ï¼ŒèˆŠç´€éŒ„ id æ˜¯å­—ä¸²ï¼Œé€™è£¡å‡è¨­åœ¨åˆ†æ•¸ç›¸åŒæ™‚ï¼Œè¼ƒæ—©çš„ç´€éŒ„å„ªå…ˆ
                // ç”±æ–¼æˆ‘å€‘æƒ³è¦åˆ†æ•¸æœ€é«˜çš„ 100 ç­†ï¼Œæ‰€ä»¥åœ¨åŒåˆ†æ™‚ï¼Œæˆ‘å€‘è®“ID (æ™‚é–“æˆ³)è¼ƒå°çš„ï¼ˆè¼ƒèˆŠçš„ï¼‰æ’å‰é¢ï¼Œä»¥ç©©å®šåæ¬¡ã€‚
                return tsA - tsB;
            });
            
            // é¡¯ç¤ºå‰ 100 å
            const topScores = scores.slice(0, 100);

            $leaderboardList.innerHTML = '';
            $loadingMsg.classList.add('hidden');
            
            if (topScores.length === 0) {
                $emptyLeaderboardMsg.classList.remove('hidden');
                return;
            }
            $emptyLeaderboardMsg.classList.add('hidden');
            
            // é‡æ–°æ‡‰ç”¨ç•¶å‰çš„æ’åºéµ (åå­—æ’åº)
            if (leaderboardSortKey === 'name') {
                 topScores.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW', { sensitivity: 'base' }));
            }

            topScores.forEach((entry, index) => {
                const rank = index + 1;
                let rankText = rank;
                let rankColor = 'text-gray-500';
                
                if (rank === 1) {
                    rankText = 'ğŸ¥‡';
                    rankColor = 'text-yellow-500';
                } else if (rank === 2) {
                    rankText = 'ğŸ¥ˆ';
                    rankColor = 'text-gray-400';
                } else if (rank === 3) {
                    rankText = 'ğŸ¥‰';
                    rankColor = 'text-amber-700';
                }
                
                // åˆ¤æ–·æ˜¯å¦ç‚ºæœ¬æ¬¡æäº¤çš„æˆç¸¾
                const isLatest = latestEntryId !== null && entry.id === latestEntryId;
                const scorePercent = entry.score; // åˆ†æ•¸å°±æ˜¯ç™¾åˆ†æ¯”

                const item = document.createElement('div');
                item.className = `flex flex-col p-4 border rounded-lg shadow-md transition-all ${isLatest ? 'bg-yellow-50 border-yellow-400 scale-[1.02] ring-2 ring-yellow-500' : 'bg-white border-gray-100'}`;
                item.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl font-black ${rankColor}">${rankText}</span>
                            <span class="text-xl font-bold text-gray-800">${entry.name} ${isLatest ? 'â­' : ''}</span>
                        </div>
                        <span class="text-3xl font-extrabold text-emerald-600">${entry.score} <span class="text-lg font-normal">åˆ†</span></span>
                    </div>
                    <!-- åˆ†æ•¸æ¢ -->
                    <div class="w-full bg-gray-100 h-2 rounded-md overflow-hidden">
                        <div class="score-bar" style="width: ${scorePercent}%;"></div>
                    </div>
                    <p class="text-xs text-right ${isLatest ? 'text-yellow-700' : 'text-gray-400'} mt-1">æ—¥æœŸï¼š${entry.date}</p>
                    <!-- é¡¯ç¤º User ID æ–¹ä¾¿é™¤éŒ¯å’Œè­˜åˆ¥ -->
                    <p class="text-xs text-left text-gray-300 mt-1">ID: ${entry.userId || 'N/A'}</p>
                `;
                $leaderboardList.appendChild(item);
            });
            
            lucide.createIcons();
            
            // æ¯æ¬¡æ¸²æŸ“å®Œç•¢å¾Œï¼ŒåŸ·è¡Œä¿®å‰ªé‚è¼¯ (ç¢ºä¿æ•¸æ“šåº«å¤§å°å¯æ§)
            pruneScores(scores);
        }
        
        // å•Ÿå‹• Firestore ç›£è½å™¨
        let unsubscribe = null;
        let latestEntryId = null;

        async function startLeaderboardListener() {
            if (!window.isAuthReady) return;
            
            // 1. è™•ç† URL ä¸­çš„æ–°åˆ†æ•¸ (å„²å­˜)
            const params = getUrlParams();
            if (params.name && params.score) {
                const newEntry = await processNewScore(params);
                if (newEntry) {
                    latestEntryId = newEntry.id;
                    // æ¸…é™¤ URL åƒæ•¸
                    try {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } catch (e) {
                        console.warn("ç„¡æ³•æ›¿æ›æ­·å²ç‹€æ…‹ (replaceState):", e);
                    }
                }
            }

            // 2. å•Ÿå‹• Firestore å¯¦æ™‚ç›£è½ (onSnapshot)
            if (unsubscribe) unsubscribe();

            const q = window.query(window.collection(window.db, window.COLLECTION_PATH));
            
            unsubscribe = window.onSnapshot(q, (querySnapshot) => {
                allScores = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // ç¢ºä¿ timestamp æ¬„ä½å­˜åœ¨ï¼Œå¦å‰‡è³¦äºˆä¸€å€‹ç•¶å‰æ™‚é–“
                    if (!data.timestamp) {
                        data.timestamp = window.firebase.firestore.Timestamp.now();
                    }
                    allScores.push({ id: doc.id, ...data });
                });
                
                // ä½¿ç”¨è¼‰å…¥çš„æ•¸æ“šé€²è¡Œæ¸²æŸ“
                renderLeaderboard(allScores, latestEntryId);
                // æ¸²æŸ“å¾Œæ¸…é™¤ latestEntryIdï¼Œé¿å…æ’åºåˆ‡æ›æ™‚é«˜äº®éŒ¯èª¤
                latestEntryId = null;
            }, (error) => {
                console.error("Error listening to leaderboard: ", error);
                $loadingMsg.textContent = "è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–æ¬Šé™ã€‚";
            });
        }
        
        /** é¡¯ç¤ºå¯†ç¢¼ Modal */
        function showClearPasswordModal() {
            $passwordInput.value = '';
            $passwordError.classList.add('hidden');
            $passwordModal.classList.remove('hidden');
            $passwordInput.focus();
        }

        /** å–æ¶ˆæ¸…é™¤ */
        function cancelClear() {
            $passwordModal.classList.add('hidden');
        }
        
        /** å¯†ç¢¼é©—è­‰é‚è¼¯ (Firestore åˆªé™¤) */
        async function verifyPasswordAndClear() {
            if (!window.isAuthReady) return;

            const enteredPassword = $passwordInput.value.trim();
            $passwordError.classList.add('hidden');
            
            if (enteredPassword === ADMIN_PASSWORD) {
                // é©—è­‰æˆåŠŸï¼ŒåŸ·è¡Œæ¸…é™¤æ“ä½œ
                $loadingMsg.classList.remove('hidden');
                $loadingMsg.textContent = "æ­£åœ¨æ¸…é™¤æ‰€æœ‰ç´€éŒ„...";

                try {
                    // ç²å–æ‰€æœ‰æ–‡ä»¶ ID
                    const snapshot = await window.getDocs(window.query(window.collection(window.db, window.COLLECTION_PATH)));
                    
                    // åŸ·è¡Œåˆªé™¤
                    const deletePromises = [];
                    snapshot.forEach((docRef) => {
                        deletePromises.push(window.deleteDoc(window.doc(window.db, window.COLLECTION_PATH, docRef.id)));
                    });
                    
                    await Promise.all(deletePromises);
                    
                    // éš±è— Modal
                    $passwordModal.classList.add('hidden');
                    
                    console.log("All scores successfully cleared from Firestore.");

                } catch (e) {
                    console.error("Error clearing scores:", e);
                    $passwordError.textContent = `æ¸…é™¤å¤±æ•—: ${e.message}`;
                    $passwordError.classList.remove('hidden');
                }

            } else {
                // é©—è­‰å¤±æ•—
                $passwordError.textContent = "å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚";
                $passwordError.classList.remove('hidden');
                $passwordInput.focus();
            }
        }
        
        // --- åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½å™¨ ---
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. åˆå§‹åŒ– Firebase å’Œèº«ä»½é©—è­‰
            const isReady = await window.initFirebaseAndAuth();
            
            if (isReady) {
                // 2. å•Ÿå‹•æ’è¡Œæ¦œæ•¸æ“šç›£è½
                startLeaderboardListener();
            } else {
                $loadingMsg.textContent = "ç„¡æ³•é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚";
            }

            // 3. ç¶å®šæ’åºäº‹ä»¶
            $sortScoreBtn.addEventListener('click', () => {
                leaderboardSortKey = 'score';
                $sortScoreBtn.classList.add('selected');
                $sortNameBtn.classList.remove('selected');
                renderLeaderboard(allScores);
            });
            $sortNameBtn.addEventListener('click', () => {
                leaderboardSortKey = 'name';
                $sortNameBtn.classList.add('selected');
                $sortScoreBtn.classList.remove('selected');
                renderLeaderboard(allScores);
            });

            // 4. ç¶å®šæ¸…é™¤äº‹ä»¶ (è§¸ç™¼å¯†ç¢¼ Modal)
            $clearLeaderboardBtn.addEventListener('click', showClearPasswordModal);
            
            // 5. ç¶å®šå¯†ç¢¼ Modal äº‹ä»¶
            $cancelClearBtn.addEventListener('click', cancelClear);
            $confirmClearBtn.addEventListener('click', verifyPasswordAndClear);
            
            // å…è¨±åœ¨å¯†ç¢¼è¼¸å…¥æ¡†æŒ‰ Enter éµç¢ºèª
            $passwordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    verifyPasswordAndClear();
                }
            });

            lucide.createIcons(); // ç¢ºä¿æ‰€æœ‰ icon éƒ½è¢«æ¸²æŸ“
        });
    </script>
</body>
</html>
