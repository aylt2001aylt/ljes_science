<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£å²©çŸ³èˆ‡ç¤¦ç‰©ï¼šåœ–é‘‘èˆ‡æ¸¬é©—</title>
    <!-- è¼‰å…¥ Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Lucide Icons --><script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* å­—å‹å»ºè­°ï¼šNoto Sans TC / Inter */
        html { font-family: 'Inter', 'Noto Sans TC', sans-serif; }

        /* è‡ªå®šç¾©é¡è‰²è®Šæ•¸ */
        :root {
            --color-bg-primary: #f9fafb; /* ç±³ç™½ */
            --color-bg-secondary: #ecfdf5; /* æ·ºç¶  (Emerald-50) */
            --color-main: #10b981; /* ä¸»ç¶ è‰² (Emerald-500) */
            --color-accent: #6b7280; /* å²©ç°è‰² (Gray-500) */
            --color-text: #1f2937;
        }

        body {
            background-color: var(--color-bg-secondary); /* æ·ºç¶ èƒŒæ™¯ */
            color: var(--color-text);
            padding-bottom: 4rem;
        }

        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* æŸ”å’Œé™°å½± */
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        /* ------------------- åœ–é‘‘/æ’è¡Œæ¦œæ¨¡å¼æ¨£å¼ ------------------- */
        .keyword-btn {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 200ms;
            cursor: pointer;
            border: 1px solid transparent;
            background-color: #e5e7eb; /* æ·ºç°åº• */
            color: var(--color-text);
        }
        .keyword-btn.selected {
            background-color: var(--color-main);
            color: white;
            box-shadow: 0 2px 5px rgba(16, 185, 129, 0.4);
            transform: translateY(-1px);
        }
        /* ------------------- æ¸¬é©—æ¨¡å¼æ¨£å¼ ------------------- */
        .option-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            background-color: #f9fafb;
            transition: all 0.2s;
            font-weight: 500;
            color: var(--color-text);
        }

        .option-btn:hover:not(.selected) {
            border-color: #a7f3d0; /* Emerald-200 */
            background-color: #d1fae5; /* Emerald-100 */
            transform: translateY(-1px);
        }

        .option-btn.selected {
            border-color: var(--color-main);
            background-color: var(--color-main);
            color: white;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3);
        }

        .main-button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            background-color: var(--color-main);
            color: white;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.4);
            transition: all 0.2s;
        }

        .main-button:hover {
            background-color: #059669; /* Emerald-600 */
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(16, 185, 129, 0.5);
        }

        /* â­ æ»¿åˆ†ç‰¹æ•ˆ CSS */
        @keyframes sparkle {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0; }
        }

        .confetti-star {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #ffcc00; /* Yellow star color */
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 66% 57%, 79% 91%, 50% 70%, 21% 91%, 34% 57%, 2% 35%, 39% 35%);
            animation: sparkle 1s ease-out infinite;
            pointer-events: none;
        }
        .perfect-score-glow {
            box-shadow: 0 0 20px #fbbf24, 0 0 40px #f59e0b; /* Amber 400/500 */
            border: 4px solid #f59e0b;
        }
        
        /* æ’è¡Œæ¦œåˆ†æ•¸æ¢æ¨£å¼ */
        .score-bar {
            background-color: var(--color-main);
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease-out;
            min-width: 2%; 
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- 1ï¸âƒ£ é ‚éƒ¨å€å¡Šï¼šæ—¥æœŸèˆ‡æ¨™é¡Œ -->
    <header class="bg-white sticky top-0 z-10 shadow-md py-4">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <p id="current-date" class="text-sm text-gray-500 mb-1 font-semibold"></p>
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 flex items-center">
                <i id="header-icon" data-lucide="gem" class="inline-block w-8 h-8 mr-2 text-yellow-500"></i>
                <span id="header-title">å°ç£å²©çŸ³èˆ‡ç¤¦ç‰©å°å¹«æ‰‹</span>
            </h1>
            <p id="header-subtitle" class="mt-2 text-base sm:text-lg text-gray-600 border-b pb-3 border-gray-100">
                é€éé—œéµå­—ç¯©é¸ï¼Œæ‰¾å‡ºä½ æ­£åœ¨å°‹æ‰¾çš„å²©çŸ³æˆ–ç¤¦ç‰©ï¼
            </p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 space-y-10">

        <!-- æ¨¡å¼åˆ‡æ›å€ (æ–°å¢æ’è¡Œæ¦œæŒ‰éˆ•) -->
        <div class="flex justify-center mb-6">
            <button id="mode-gallery-btn" class="px-6 py-2 rounded-l-lg font-semibold transition-colors border border-r-0" data-mode="gallery">
                <i data-lucide="compass" class="w-4 h-4 mr-1 inline-block"></i> åœ–é‘‘ç¯©é¸
            </button>
            <button id="mode-quiz-btn" class="px-6 py-2 font-semibold transition-colors border" data-mode="quiz">
                <i data-lucide="scroll-text" class="w-4 h-4 mr-1 inline-block"></i> æ¸¬é©—æŒ‘æˆ°
            </button>
            <button id="mode-leaderboard-btn" class="px-6 py-2 rounded-r-lg font-semibold transition-colors border border-l-0" data-mode="leaderboard">
                <i data-lucide="trophy" class="w-4 h-4 mr-1 inline-block"></i> æ’è¡Œæ¦œ
            </button>
        </div>

        <!-- 1. åœ–é‘‘/ç¯©é¸æ¨¡å¼ (Gallery Mode) -->
        <div id="gallery-mode" class="space-y-10">
            <!-- 2ï¸âƒ£ é—œéµå­—é¸æ“‡å€ -->
            <section class="card">
                <h2 class="text-2xl font-bold mb-4 flex items-center text-gray-700">
                    <i data-lucide="filter" class="w-5 h-5 mr-2 text-blue-400"></i>
                    é—œéµå­—ç¯©é¸
                </h2>
                
                <div id="keyword-selection" class="space-y-6">
                    <!-- é¡è‰² -->
                    <div>
                        <h3 class="font-semibold text-lg mb-2 text-gray-600">ğŸ’ é¡è‰²ï¼š</h3>
                        <div id="color-keywords" class="flex flex-wrap gap-2">
                            <!-- Buttons injected by JS -->
                        </div>
                    </div>

                    <!-- ç‰¹å¾µ -->
                    <div>
                        <h3 class="font-semibold text-lg mb-2 text-gray-600">ğŸ”¬ ç‰¹å¾µèˆ‡çµæ§‹ï¼š</h3>
                        <div id="feature-keywords" class="flex flex-wrap gap-2">
                            <!-- Buttons injected by JS -->
                        </div>
                    </div>

                    <!-- æ¸…é™¤æŒ‰éˆ• -->
                    <div class="pt-4 border-t border-gray-100 flex justify-end">
                        <button id="clear-keywords-btn" class="px-4 py-2 text-sm font-medium text-red-500 hover:text-red-700 transition-colors">
                            <i data-lucide="x-circle" class="w-4 h-4 mr-1 inline-block"></i>
                            æ¸…é™¤æ‰€æœ‰ç¯©é¸
                        </button>
                    </div>
                </div>
            </section>

            <!-- 3ï¸âƒ£ ç¤¦çŸ³åœ–é‘‘å€ -->
            <section class="card space-y-4">
                
                <!-- ç¯©é¸å‰çš„æç¤ºè¨Šæ¯ (é è¨­é¡¯ç¤º) -->
                <p id="filter-prompt-message" class="text-center text-xl text-gray-500 py-8 font-semibold">
                    è«‹åœ¨ä¸Šæ–¹é¸æ“‡è‡³å°‘ä¸€å€‹é—œéµå­—ä¾†é–‹å§‹ç¯©é¸åœ–é‘‘ã€‚
                </p>
                
                <!-- åœ–é‘‘å…§å®¹å€ (é è¨­éš±è—ï¼Œæœ‰ç¯©é¸æ¢ä»¶æ™‚é¡¯ç¤º) -->
                <div id="gallery-content-wrapper" class="hidden">
                    <h2 class="text-2xl font-bold flex items-center text-gray-700">
                        <i data-lucide="search" class="w-5 h-5 mr-2 text-purple-400"></i>
                        ç¬¦åˆç¯©é¸çš„å²©çŸ³èˆ‡ç¤¦ç‰©åœ–é‘‘
                    </h2>
                    <p class="text-sm text-gray-500 mb-4">æ ¹æ“šæ‚¨é¸æ“‡çš„é—œéµå­—ç¯©é¸çµæœ (é»æ“Šåœ–ç‰‡å¯æŸ¥çœ‹è©³æƒ…)ã€‚</p>
                    <div id="specimen-gallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        <!-- Cards injected by JS -->
                    </div>
                    <p id="no-result-message" class="hidden text-center text-lg text-gray-500 py-8">
                        æ‰¾ä¸åˆ°ç¬¦åˆæ‰€æœ‰é—œéµå­—çš„å²©çŸ³æˆ–ç¤¦çŸ³ã€‚è«‹è©¦è‘—æ¸›å°‘é—œéµå­—ï¼
                    </p>
                </div>
            </section>
        </div>
        
        <!-- 2. æ¸¬é©—æ¨¡å¼ (Quiz Mode) -->
        <div id="quiz-mode" class="hidden max-w-3xl mx-auto">
            <!-- 2ï¸âƒ£ é–‹å§‹ç•«é¢ (Start Screen) -->
            <section id="start-screen" class="card">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">æº–å‚™é–‹å§‹æ¸¬é©—ï¼</h2>
                <p class="text-gray-600 mb-6">è«‹è¼¸å…¥ä½ çš„å§“åï¼Œç„¶å¾Œé–‹å§‹æŒ‘æˆ° 10 é¡Œç‰¹å¾µ/ç”¨é€”è¾¨è­˜é¡Œã€‚</p>
                
                <label for="student-name-input" class="block text-sm font-medium text-gray-700 mb-2">ä½ çš„å§“åï¼š</label>
                <input type="text" id="student-name-input" placeholder="è«‹è¼¸å…¥å§“å" class="w-full p-3 mb-6 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors">
                
                <button id="start-quiz-btn" class="main-button w-full">
                    <i data-lucide="play" class="w-5 h-5 mr-2 inline-block"></i>
                    é–‹å§‹æ¸¬é©— (10 é¡Œ)
                </button>
            </section>

            <!-- 3ï¸âƒ£ æ¸¬é©—ç•«é¢ (Quiz Screen) -->
            <section id="quiz-screen" class="card hidden">
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
                    <h3 class="text-xl font-bold text-gray-700" id="question-header">ç¬¬ 1/10 é¡Œ</h3>
                    <p class="text-gray-500">å­¸ç”Ÿï¼š<span id="student-name-display" class="font-semibold text-gray-700"></span></p>
                </div>

                <div class="text-center mb-6">
                    <!-- æ¸¬é©—æç¤ºå·²æ›´æ–°ï¼ŒåŒ…å«ã€Œä¸»è¦ç”¨é€”ã€ -->
                    <p class="text-lg font-semibold mb-3">è«‹å¾ä¸‹åˆ—é¸é …ä¸­é¸å‡ºåœ–ç‰‡ä¸­å²©çŸ³/ç¤¦ç‰©çš„ä¸€é …ã€Œæ­£ç¢ºç‰¹å¾µæˆ–ä¸»è¦ç”¨é€”ã€ï¼š</p>
                    <div class="w-full max-w-sm h-64 mx-auto rounded-xl overflow-hidden bg-gray-200 flex items-center justify-center border-4 border-gray-300 shadow-md">
                        <img id="mineral-image" src="" class="w-full h-full object-cover" alt="å¾…è¾¨è­˜çš„å²©çŸ³æˆ–ç¤¦ç‰©åœ–ç‰‡" onerror="this.onerror=null;this.src='https://placehold.co/256x256/6b7280/ffffff?text=åœ–ç‰‡è¼‰å…¥å¤±æ•—';">
                    </div>
                </div>

                <div id="options-container" class="space-y-3">
                    <!-- é¸é …å°‡ç”± JS æ³¨å…¥ -->
                </div>

                <div class="mt-8 pt-4 border-t border-gray-100 flex justify-end">
                    <button id="next-question-btn" class="main-button disabled:opacity-50" disabled>
                        ä¸‹ä¸€é¡Œ
                        <i data-lucide="arrow-right" class="w-5 h-5 ml-1 inline-block"></i>
                    </button>
                </div>
            </section>

            <!-- 4ï¸âƒ£ çµæœç•«é¢ (Result Screen) -->
            <section id="result-screen" class="card hidden text-center">
                <h2 class="text-4xl font-extrabold mb-4 text-emerald-600">æ¸¬é©—çµæœå‡ºçˆï¼</h2>
                <div class="p-6 bg-emerald-50 rounded-lg inline-block relative overflow-hidden transition-all duration-300" id="score-display-box">
                    <p class="text-xl text-gray-700">å­¸ç”Ÿï¼š<span id="result-name" class="font-bold text-emerald-700"></span></p>
                    <p class="text-5xl font-black mt-4 text-emerald-800">
                        ç¸½åˆ†ï¼š<span id="final-score">0</span> / 100 åˆ†
                    </p>
                </div>
                
                <div class="mt-6">
                    <p id="result-message" class="text-lg text-gray-600 font-medium"></p>
                </div>

                <!-- â­ æŸ¥çœ‹æ’è¡Œæ¦œæŒ‰éˆ• (ä¸»æŒ‰éˆ•) - ç¾æ”¹ç‚ºåˆ‡æ›æ¨¡å¼ -->
                <button id="view-leaderboard-btn" class="main-button mt-8 w-full">
                    <i data-lucide="trophy" class="w-5 h-5 mr-2 inline-block"></i>
                    æŸ¥çœ‹æ’è¡Œæ¦œ
                </button>
                <!-- é‡æ–°é–‹å§‹æŒ‰éˆ• (æ¬¡è¦æŒ‰éˆ•) -->
                <button id="restart-quiz-btn" class="mt-4 px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors">
                    <i data-lucide="rotate-ccw" class="w-4 h-4 mr-1 inline-block"></i>
                    é‡æ–°é–‹å§‹æ¸¬é©—
                </button>
            </section>
        </div>

        <!-- 3. æ’è¡Œæ¦œæ¨¡å¼ (Leaderboard Mode) - ç°¡åŒ–å¾Œçš„å€å¡Š -->
        <div id="leaderboard-mode" class="hidden max-w-3xl mx-auto">
            <section class="card space-y-6">
                <h2 class="text-2xl font-bold mb-4 flex items-center text-gray-700">
                    <i data-lucide="trophy" class="w-6 h-6 mr-2 text-yellow-500"></i>
                    æ¸¬é©—æˆç¸¾æ’è¡Œæ¦œ
                </h2>
                <!-- UPDATE: èªªæ˜æ”¹ç‚ºåˆ†æ•¸èˆ‡æ™‚é–“ç‚ºæº– -->
                <p class="text-gray-600 mb-6">æ’è¡Œæ¦œä»¥åˆ†æ•¸é«˜ä½ç‚ºæ¨™æº–ï¼Œåˆ†æ•¸ç›¸åŒæ™‚ï¼Œä»¥å®Œæˆæ¸¬é©—æ™‚é–“è¼ƒæ—©è€…å„ªå…ˆã€‚</p>
                
                <!-- REMOVE: æ’åºé¸æ“‡æŒ‰éˆ• -->

                <!-- æ’è¡Œæ¦œåˆ—è¡¨ -->
                <div id="leaderboard-list" class="space-y-3">
                    <!-- Leaderboard items injected by JS -->
                </div>
                
                <p id="empty-leaderboard-msg" class="text-center text-lg text-gray-500 py-4 hidden">
                    ç›®å‰é‚„æ²’æœ‰æˆç¸¾ï¼Œè¶•å¿«å»æŒ‘æˆ°æ¸¬é©—å§ï¼
                </p>
                
                <button id="clear-leaderboard-btn" class="mt-6 px-4 py-2 text-sm font-medium text-red-500 hover:text-red-700 transition-colors">
                    <i data-lucide="trash-2" class="w-4 h-4 mr-1 inline-block"></i>
                    æ¸…é™¤æ‰€æœ‰ç´€éŒ„
                </button>
            </section>
        </div>
        
    </main>

    <!-- ç¤¦çŸ³è©³æƒ… Modal (é»æ“Šå¡ç‰‡å¾Œå½ˆå‡º) -->
    <div id="detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden transition-opacity">
        <div class="card w-full max-w-lg overflow-hidden relative" id="modal-content">
            <button id="close-modal-btn-top" class="absolute top-3 right-3 p-2 rounded-full hover:bg-gray-100 text-gray-500">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <!-- Modal Content Injected by JS -->
        </div>
    </div>
    
    <!-- â­ å¯†ç¢¼é©—è­‰ Modal è¦–çª— (for clear) -->
    <div id="password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden transition-opacity">
        <div class="card w-full max-w-sm relative">
            <h3 class="text-xl font-bold mb-4 text-red-600 flex items-center">
                <i data-lucide="lock" class="w-5 h-5 mr-2"></i>
                éœ€è¦ç®¡ç†å“¡å¯†ç¢¼
            </h3>
            <p class="text-gray-600 mb-4">è«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¢ºèªæ¸…é™¤æ‰€æœ‰æ’è¡Œæ¦œç´€éŒ„ã€‚</p>

            <input type="password" id="password-input" placeholder="å¯†ç¢¼" class="w-full p-3 mb-4 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-colors">
            
            <p id="password-error" class="text-red-500 text-sm mb-4 hidden">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚</p>

            <div class="flex justify-end space-x-3">
                <button id="cancel-clear-btn" class="px-4 py-2 text-sm font-medium text-gray-500 hover:bg-gray-100 rounded-lg">
                    å–æ¶ˆ
                </button>
                <button id="confirm-clear-btn" class="px-4 py-2 text-sm font-medium main-button bg-red-500 hover:bg-red-600 shadow-md shadow-red-300">
                    ç¢ºèªæ¸…é™¤
                </button>
            </div>
        </div>
    </div>


    <!-- é å°¾ï¼ˆFooterï¼‰ -->
    <footer class="mt-10 py-4 border-t border-gray-200 text-center text-gray-500 text-sm bg-white shadow-inner">
        <p>Â© 2025 å°ç£å²©çŸ³èˆ‡ç¤¦ç‰©å°å¹«æ‰‹ | Designed for å…­å¹´ç´šè‡ªç„¶ç§‘å­¸å­¸ç¿’</p>
    </footer>

    <script>
        // --- æ•¸æ“šå®šç¾© ---
        const MINERALS = [
            { id: 'quartz', name: 'çŸ³è‹±', engName: 'Quartz', type: 'ç¤¦ç‰©', color: ['ç™½è‰²', 'ç°è‰²', 'é€æ˜'], features: ['ç¤¦ç‰©', 'ç™½è‰²', 'ç°è‰²', 'é€æ˜', 'å¯åˆ®ç»ç’ƒ', 'ç»ç’ƒå…‰æ¾¤', 'æœ‰çµæ™¶'], habitat: 'å¸¸è¦‹æ–¼èŠ±å´—å²©ä¸­ï¼Œæ˜¯åœ°æ®¼ä¸­å«é‡ç¬¬äºŒå¤šçš„ç¤¦ç‰©ã€‚', usage: 'é›»å­å…ƒä»¶ã€ç»ç’ƒåŸæ–™ã€å¯¶çŸ³', imageUrl: 'images/Quartz.png' },
            { id: 'biotite', name: 'é»‘é›²æ¯', engName: 'Biotite', type: 'ç¤¦ç‰©', color: ['é»‘è‰²', 'æ·±æ£•è‰²'], features: ['ç¤¦ç‰©', 'é»‘è‰²', 'æ·±æ£•è‰²', 'ç‰‡ç‹€å‰è½', 'ç»ç’ƒå…‰æ¾¤', 'æœ‰å±¤ç‹€æ§‹é€ '], habitat: 'å»£æ³›åˆ†ä½ˆæ–¼ç«æˆå²©å’Œè®Šè³ªå²©ä¸­ã€‚', usage: 'çµ•ç·£ææ–™', imageUrl: 'images/Biotite.png' },
            { id: 'calcite', name: 'æ–¹è§£çŸ³', engName: 'Calcite', type: 'ç¤¦ç‰©', color: ['ç™½è‰²', 'é€æ˜'], features: ['ç¤¦ç‰©', 'ç™½è‰²', 'é€æ˜', 'é‡é…¸èµ·æ³¡', 'ç»ç’ƒå…‰æ¾¤', 'æœ‰çµæ™¶', 'è±å½¢è§£ç†'], habitat: 'è¨±å¤šå²©çŸ³å’Œé˜ä¹³çŸ³çš„ä¸»è¦æˆåˆ†ã€‚', usage: 'å…‰å­¸å„€å™¨ã€æ°´æ³¥åŸæ–™', imageUrl: 'images/Calcite.png' },
            { id: 'sulfur', name: 'ç¡«ç£º', engName: 'Sulfur', type: 'ç¤¦ç‰©', color: ['é»ƒè‰²'], features: ['ç¤¦ç‰©', 'é»ƒè‰²', 'ç«å±±å™´ç™¼å£å‘¨åœ', 'è Ÿç‹€å…‰æ¾¤', 'æ˜“ç‡ƒ'], habitat: 'ä¸»è¦ç”¢æ–¼ç«å±±æ´»å‹•å€åŸŸï¼Œå¦‚é™½æ˜å±±ã€‚', usage: 'å·¥æ¥­åŸæ–™ã€è—¥ç”¨', imageUrl: 'images/Sulfur.png' },
            { id: 'talc', name: 'æ»‘çŸ³', engName: 'Talc', type: 'ç¤¦ç‰©', color: ['ç™½è‰²', 'æ·ºç¶ è‰²'], features: ['ç¤¦ç‰©', 'ç™½è‰²', 'æ·ºç¶ è‰²', 'çš‚æ„Ÿ', 'çç å…‰æ¾¤'], habitat: 'ä¸»è¦ç”±è®Šè³ªä½œç”¨å½¢æˆã€‚', usage: 'åŒ–å¦å“ã€å¡—æ–™ã€é›•åˆ»', imageUrl: 'images/Talc.png' },
            { id: 'muscovite', name: 'ç™½é›²æ¯', engName: 'Muscovite', type: 'ç¤¦ç‰©', color: ['é€æ˜', 'éŠ€ç™½è‰²'], features: ['ç¤¦ç‰©', 'é€æ˜', 'éŠ€ç™½è‰²', 'ç‰‡ç‹€å‰è½', 'çç å…‰æ¾¤', 'æœ‰å±¤ç‹€æ§‹é€ '], habitat: 'å¸¸è¦‹æ–¼èŠ±å´—å²©å’Œç‰‡éº»å²©ä¸­ã€‚', usage: 'çµ•ç·£ææ–™ã€è£é£¾', imageUrl: 'images/Muscovite.png' },
            { id: 'graphite', name: 'çŸ³å¢¨', engName: 'Graphite', type: 'ç¤¦ç‰©', color: ['é»‘è‰²', 'ç°è‰²'], features: ['ç¤¦ç‰©', 'é»‘è‰²', 'ç°è‰²', 'é‡‘å±¬å…‰æ¾¤', 'æœ‰æ¢ç—•', 'å¯å°é›»'], habitat: 'ç”±è®Šè³ªä½œç”¨å½¢æˆï¼Œæ˜¯ç¢³çš„åŒç´ ç•°å½¢é«”ã€‚', usage: 'é‰›ç­†ã€æ½¤æ»‘åŠ‘ã€é›»æ± ', imageUrl: 'images/Graphite.png' },
            { id: 'andesite', name: 'å®‰å±±å²©', engName: 'Andesite', type: 'ç«æˆå²©', color: ['ç°è‰²', 'é»‘è‰²'], features: ['ç«æˆå²©', 'ç°è‰²', 'é»‘è‰²', 'å°ç£å¸¸è¦‹', 'å¯åˆ®ç»ç’ƒ'], habitat: 'å°ç£å¤§å±¯å±±ã€è§€éŸ³å±±ç­‰ç«å±±åœ°å€å¸¸è¦‹çš„ç«å±±å²©ã€‚', usage: 'å»ºç¯‰çŸ³æã€è·¯åŸº', imageUrl: 'images/Andesite.png' },
            { id: 'granite', name: 'èŠ±å´—å²©', engName: 'Granite', type: 'ç«æˆå²©', color: ['ç°è‰²', 'ç™½è‰²', 'é»‘è‰²', 'ç²‰ç´…'], features: ['ç«æˆå²©', 'ç°è‰²', 'ç™½è‰²', 'é»‘è‰²', 'ç²‰ç´…', 'æ·±å±¤å½¢æˆ', 'æœ‰çµæ™¶', 'å¯åˆ®ç»ç’ƒ'], habitat: 'å°ç£æ±éƒ¨å±±å€å¸¸è¦‹çš„æ·±å±¤ç«æˆå²©ã€‚', usage: 'å»ºç¯‰çŸ³æã€é›•åˆ»', imageUrl: 'images/Granite.png' },
            { id: 'basalt', name: 'ç„æ­¦å²©', engName: 'Basalt', type: 'ç«æˆå²©', color: ['é»‘è‰²', 'æ·±ç°è‰²'], features: ['ç«æˆå²©', 'é»‘è‰²', 'æ·±ç°è‰²', 'ç«å±±å™´å‡º', 'èœ‚çª©ç‹€'], habitat: 'å°ç£é›¢å³¶ï¼ˆå¦‚æ¾æ¹–ï¼‰å¸¸è¦‹çš„å™´å‡ºç«æˆå²©ã€‚', usage: 'é‹ªè·¯çŸ³ã€äººé€ çº–ç¶­', imageUrl: 'images/Basalt.png' },
            { id: 'limestone', name: 'çŸ³ç°å²©', engName: 'Limestone', type: 'æ²‰ç©å²©', color: ['ç°è‰²', 'ç™½è‰²', 'ç±³é»ƒ'], features: ['æ²‰ç©å²©', 'ç°è‰²', 'ç™½è‰²', 'ç±³é»ƒ', 'é‡é…¸èµ·æ³¡', 'æœ‰å±¤ç‹€æ§‹é€ ', 'ç”±ç”Ÿç‰©éºéª¸çµ„æˆ'], habitat: 'ä¸»è¦ç”±æµ·æ´‹ç”Ÿç‰©éºéª¸å½¢æˆï¼Œå°ç£è¥¿éƒ¨æœ‰åˆ†ä½ˆã€‚', usage: 'æ°´æ³¥åŸæ–™ã€å»ºç¯‰', imageUrl: 'images/Limestone.png' },
            { id: 'shale', name: 'é å²©', engName: 'Shale', type: 'æ²‰ç©å²©', color: ['ç°è‰²', 'é»‘è‰²'], features: ['æ²‰ç©å²©', 'ç°è‰²', 'é»‘è‰²', 'æœ‰å±¤ç‹€æ§‹é€ ', 'ç‰‡ç‹€å‰è½'], habitat: 'å°ç£è¥¿éƒ¨å±±å€å¸¸è¦‹ï¼Œç”±æ³¥æ¼¿å£“å¯¦è€Œæˆã€‚', usage: 'è£½ç£šã€æ°´æ³¥åŸæ–™', imageUrl: 'images/Shale.png' },
            { id: 'sandstone', name: 'ç ‚å²©', engName: 'Sandstone', type: 'æ²‰ç©å²©', color: ['é»ƒè‰²', 'è¤è‰²', 'ç´…è‰²'], features: ['æ²‰ç©å²©', 'é»ƒè‰²', 'è¤è‰²', 'ç´…è‰²', 'æœ‰å±¤ç‹€æ§‹é€ ', 'ç ‚ç²’çµ„åˆ'], habitat: 'å°ç£åŒ—éƒ¨å’Œè¥¿éƒ¨å±±å€å¸¸è¦‹ã€‚', 'usage': 'å»ºç¯‰çŸ³æã€ç£¨æ–™', imageUrl: 'images/Sandstone.png' },
            { id: 'marble', name: 'å¤§ç†å²©', engName: 'Marble', type: 'è®Šè³ªå²©', color: ['ç™½è‰²', 'ç°è‰²', 'é›œè‰²'], features: ['è®Šè³ªå²©', 'ç™½è‰²', 'ç°è‰²', 'é›œè‰²', 'æœ‰çµæ™¶', 'é‡é…¸èµ·æ³¡'], habitat: 'å°ç£æ±éƒ¨ï¼ˆèŠ±è“®ï¼‰å¸¸è¦‹ï¼Œç”±çŸ³ç°å²©è®Šè³ªè€Œæˆã€‚', usage: 'è£é£¾ã€é›•åˆ»', imageUrl: 'images/Marble.png' },
            { id: 'slate', name: 'æ¿å²©', engName: 'Slate', type: 'è®Šè³ªå²©', color: ['é»‘è‰²', 'ç°è‰²'], features: ['è®Šè³ªå²©', 'é»‘è‰²', 'ç°è‰²', 'ç‰‡ç‹€å‰è½', 'å¯åŠˆè£‚', 'æœ‰å±¤ç‹€æ§‹é€ '], habitat: 'å°ç£ä¸­éƒ¨å±±å€å¸¸è¦‹ï¼Œç”±é å²©æˆ–æ³¥å²©è®Šè³ªè€Œæˆã€‚', 'usage': 'å±‹ç“¦ã€çŸ³æ¿', imageUrl: 'images/Slate.png' },
            { id: 'gneiss', name: 'ç‰‡éº»å²©', engName: 'Gneiss', type: 'è®Šè³ªå²©', color: ['é›œè‰²'], features: ['è®Šè³ªå²©', 'é›œè‰²', 'å¸¶ç‹€æ§‹é€ ', 'æœ‰çµæ™¶'], habitat: 'å¸¸è¦‹æ–¼è®Šè³ªç¨‹åº¦è¼ƒé«˜çš„åœ°å€ã€‚', usage: 'å»ºç¯‰çŸ³æ', imageUrl: 'images/Gneiss.png' }
        ];

        const KEYWORDS = {
            'é¡è‰²': ['ç™½è‰²', 'é»‘è‰²', 'ç°è‰²', 'é»ƒè‰²', 'é€æ˜', 'éŠ€ç™½è‰²', 'ç²‰ç´…', 'æ·±æ£•è‰²', 'æ·ºç¶ è‰²', 'è¤è‰²', 'ç´…è‰²', 'ç±³é»ƒ', 'é›œè‰²'],
            'ç‰¹å¾µ': [
                'æœ‰çµæ™¶', 'æœ‰å±¤ç‹€æ§‹é€ ', 'é‡é…¸èµ·æ³¡', 'å¯åˆ®ç»ç’ƒ',
                'é‡‘å±¬å…‰æ¾¤', 'ç»ç’ƒå…‰æ¾¤', 'çç å…‰æ¾¤', 'è Ÿç‹€å…‰æ¾¤',
                'ç‰‡ç‹€å‰è½', 'å¯å°é›»', 'çš‚æ„Ÿ', 'æœ‰æ¢ç—•',
                'ç«æˆå²©', 'æ²‰ç©å²©', 'è®Šè³ªå²©', 'ç¤¦ç‰©',
                'èœ‚çª©ç‹€', 'å¸¶ç‹€æ§‹é€ ', 'ç”±ç”Ÿç‰©éºéª¸çµ„æˆ', 'ç ‚ç²’çµ„åˆ', 'ç«å±±å™´ç™¼å£å‘¨åœ', 'å¯åŠˆè£‚', 'æ·±å±¤å½¢æˆ', 'è±å½¢è§£ç†', 'å°ç£å¸¸è¦‹'
            ]
        };

        const allQuizOptionsSet = new Set();
        MINERALS.forEach(m => {
            m.features.forEach(f => allQuizOptionsSet.add(f));
            m.usage.split('ã€').forEach(u => allQuizOptionsSet.add(u.trim()));
        });
        const allQuizOptions = Array.from(allQuizOptionsSet);
        const NUM_QUESTIONS = 10;
        
        // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹è®Šæ•¸
        let currentMode = 'gallery';
        let selectedKeywords = new Set();
        let studentName = '';
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0;
        
        // æ’è¡Œæ¦œç‹€æ…‹è®Šæ•¸
        const ADMIN_PASSWORD = '7772041';
        const STORAGE_KEY = 'quiz_leaderboard';

        // --- DOM å…ƒç´ å¿«å– ---
        const $date = document.getElementById('current-date');
        const $headerTitle = document.getElementById('header-title');
        const $headerSubtitle = document.getElementById('header-subtitle');
        const $headerIcon = document.getElementById('header-icon');
        const $modeGalleryBtn = document.getElementById('mode-gallery-btn');
        const $modeQuizBtn = document.getElementById('mode-quiz-btn');
        const $modeLeaderboardBtn = document.getElementById('mode-leaderboard-btn');
        const $galleryMode = document.getElementById('gallery-mode');
        const $quizMode = document.getElementById('quiz-mode');
        const $leaderboardMode = document.getElementById('leaderboard-mode');

        // åœ–é‘‘æ¨¡å¼å…ƒç´ 
        const $colorKeywords = document.getElementById('color-keywords');
        const $featureKeywords = document.getElementById('feature-keywords');
        const $clearBtn = document.getElementById('clear-keywords-btn');
        const $gallery = document.getElementById('specimen-gallery');
        const $noResultMsg = document.getElementById('no-result-message');
        const $modal = document.getElementById('detail-modal');
        const $modalContent = document.getElementById('modal-content');
        const $galleryWrapper = document.getElementById('gallery-content-wrapper');
        const $filterPrompt = document.getElementById('filter-prompt-message');
        const $closeModalBtnTop = document.getElementById('close-modal-btn-top');

        // æ¸¬é©—æ¨¡å¼å…ƒç´ 
        const $startScreen = document.getElementById('start-screen');
        const $quizScreen = document.getElementById('quiz-screen');
        const $resultScreen = document.getElementById('result-screen');
        const $nameInput = document.getElementById('student-name-input');
        const $startBtn = document.getElementById('start-quiz-btn');
        const $nameDisplay = document.getElementById('student-name-display');
        const $questionHeader = document.getElementById('question-header');
        const $mineralImage = document.getElementById('mineral-image');
        const $optionsContainer = document.getElementById('options-container');
        const $nextBtn = document.getElementById('next-question-btn');
        const $resultName = document.getElementById('result-name');
        const $finalScore = document.getElementById('final-score');
        const $resultMessage = document.getElementById('result-message');
        const $restartBtn = document.getElementById('restart-quiz-btn');
        const $viewLeaderboardBtn = document.getElementById('view-leaderboard-btn');
        const $scoreDisplayBox = document.getElementById('score-display-box');

        // æ’è¡Œæ¦œæ¨¡å¼å…ƒç´  (ä¸å†éœ€è¦æ’åºæŒ‰éˆ•)
        const $leaderboardList = document.getElementById('leaderboard-list');
        const $emptyLeaderboardMsg = document.getElementById('empty-leaderboard-msg');
        const $clearLeaderboardBtn = document.getElementById('clear-leaderboard-btn');
        
        // å¯†ç¢¼ Modal å…ƒç´ 
        const $passwordModal = document.getElementById('password-modal');
        const $passwordInput = document.getElementById('password-input');
        const $passwordError = document.getElementById('password-error');
        const $confirmClearBtn = document.getElementById('confirm-clear-btn');
        const $cancelClearBtn = document.getElementById('cancel-clear-btn');

        // --- è¼”åŠ©å‡½æ•¸ ---

        /** äº‚åºæ’åˆ—é™£åˆ— */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        /** è‡ªå®šç¾© alert å‡½å¼ (ä½¿ç”¨ window.alert æ›¿ä»£) */
        function alert(message) {
            window.alert(message);
        }

        /** å‰µå»ºæ»¿åˆ†ç´™å±‘ç‰¹æ•ˆ */
        function createSparkles(container, count = 20) {
            container.querySelectorAll('.confetti-star').forEach(el => el.remove());

            for (let i = 0; i < count; i++) {
                const star = document.createElement('div');
                star.className = 'confetti-star';
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                star.style.left = `${x}%`;
                star.style.top = `${y}%`;
                const size = Math.random() * 10 + 5;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.animationDelay = `${Math.random() * 0.5}s`;
                container.appendChild(star);
            }
        }
        
        /** æ ¼å¼åŒ–æ™‚é–“ (æ™‚:åˆ†:ç§’) */
        function formatTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        }

        // --- æ’è¡Œæ¦œæ•¸æ“šæ“ä½œ (LocalStorage) ---

        /** å¾ localStorage ç²å–æˆç¸¾åˆ—è¡¨ */
        function getScores() {
            const scoresJson = localStorage.getItem(STORAGE_KEY);
            return scoresJson ? JSON.parse(scoresJson) : [];
        }

        /** å°‡æ–°æˆç¸¾åŠ å…¥åˆ—è¡¨ä¸¦å„²å­˜åˆ° localStorage */
        function addScore(name, scoreValue) {
            if (!name || isNaN(scoreValue)) return;
            
            const scores = getScores();
            const newEntry = { 
                id: Date.now(), // å”¯ä¸€ ID (æ™‚é–“æˆ³)
                name: name, 
                score: Math.max(0, Math.min(100, scoreValue)), 
                date: new Date().toLocaleDateString('zh-TW'),
                timestamp: Date.now()
            };
            scores.push(newEntry);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(scores));
        }

        /** æ¸²æŸ“æ’è¡Œæ¦œ (å›ºå®šåˆ†æ•¸/æ™‚é–“æ’åº) */
        function renderLeaderboard() {
            let scores = getScores();

            // æ’åºé‚è¼¯ï¼šåˆ†æ•¸é«˜åˆ°ä½ï¼Œåˆ†æ•¸ç›¸åŒæ™‚æ™‚é–“æˆ³å°ï¼ˆæ™‚é–“æ—©ï¼‰çš„åœ¨å‰
            scores.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return a.timestamp - b.timestamp; 
            });

            $leaderboardList.innerHTML = '';
            
            if (scores.length === 0) {
                $emptyLeaderboardMsg.classList.remove('hidden');
                return;
            }
            $emptyLeaderboardMsg.classList.add('hidden');
            
            scores.forEach((entry, index) => {
                const rank = index + 1;
                let rankText = rank;
                let rankColor = 'text-gray-500';
                
                if (rank === 1) {
                    rankText = 'ğŸ¥‡';
                    rankColor = 'text-yellow-500';
                } else if (rank === 2) {
                    rankText = 'ğŸ¥ˆ';
                    rankColor = 'text-gray-400';
                } else if (rank === 3) {
                    rankText = 'ğŸ¥‰';
                    rankColor = 'text-amber-700';
                }
                
                const item = document.createElement('div');
                item.className = `flex flex-col p-4 border rounded-lg shadow-md transition-all bg-white border-gray-100`;
                item.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl font-black ${rankColor}">${rankText}</span>
                            <!-- UPDATE: ä¿ç•™å§“åé¡¯ç¤º -->
                            <span class="text-xl font-bold text-gray-800">${entry.name}</span>
                        </div>
                        <span class="text-3xl font-extrabold text-emerald-600">${entry.score} <span class="text-lg font-normal">åˆ†</span></span>
                    </div>
                    <!-- åˆ†æ•¸æ¢ -->
                    <div class="w-full bg-gray-100 h-2 rounded-md overflow-hidden">
                        <div class="score-bar" style="width: ${entry.score}%;"></div>
                    </div>
                    <!-- UPDATE: å¢åŠ å®Œæˆæ¸¬é©—æ™‚é–“ (æ™‚:åˆ†:ç§’) -->
                    <p class="text-xs text-right text-gray-500 mt-1">
                        å®Œæˆæ™‚é–“: ${formatTime(entry.timestamp)} (æ—¥æœŸ: ${entry.date})
                    </p>
                `;
                $leaderboardList.appendChild(item);
            });
            lucide.createIcons();
        }

        /** é¡¯ç¤ºå¯†ç¢¼ Modal */
        function showClearPasswordModal() {
            $passwordInput.value = '';
            $passwordError.classList.add('hidden');
            $passwordModal.classList.remove('hidden');
            $passwordInput.focus();
        }

        /** å–æ¶ˆæ¸…é™¤ */
        function cancelClear() {
            $passwordModal.classList.add('hidden');
        }
        
        /** å¯†ç¢¼é©—è­‰é‚è¼¯ (localStorage åˆªé™¤) */
        function verifyPasswordAndClear() {
            const enteredPassword = $passwordInput.value.trim();
            $passwordError.classList.add('hidden');
            
            if (enteredPassword === ADMIN_PASSWORD) {
                localStorage.removeItem(STORAGE_KEY);
                $passwordModal.classList.add('hidden');
                renderLeaderboard();
                alert("æ’è¡Œæ¦œç´€éŒ„å·²æˆåŠŸæ¸…é™¤ï¼"); 
            } else {
                $passwordError.textContent = "å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚";
                $passwordError.classList.remove('hidden');
                $passwordInput.focus();
            }
        }

        // --- æ ¸å¿ƒæ¨¡å¼åˆ‡æ›é‚è¼¯ ---

        /** åˆ‡æ›ä¸»æ‡‰ç”¨ç¨‹å¼æ¨¡å¼ */
        function showAppMode(mode) {
            currentMode = mode;
            $galleryMode.classList.add('hidden');
            $quizMode.classList.add('hidden');
            $leaderboardMode.classList.add('hidden');

            const allModeButtons = [$modeGalleryBtn, $modeQuizBtn, $modeLeaderboardBtn];

            allModeButtons.forEach(btn => {
                if (btn) btn.classList.remove('bg-emerald-500', 'text-white', 'border-emerald-500');
                if (btn) btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
            });

            // èª¿æ•´é‚Šç•Œæ¨£å¼
            $modeGalleryBtn.classList.remove('border-r-0');
            $modeQuizBtn.classList.remove('border-l-0', 'border-r-0');
            $modeLeaderboardBtn.classList.remove('border-l-0');

            if (mode === 'gallery') {
                $galleryMode.classList.remove('hidden');
                $modeGalleryBtn.classList.add('bg-emerald-500', 'text-white', 'border-emerald-500');
                $modeQuizBtn.classList.add('border-l-0');
                $modeLeaderboardBtn.classList.add('border-l-0');
                $headerTitle.textContent = 'å°ç£å²©çŸ³èˆ‡ç¤¦ç‰©å°å¹«æ‰‹';
                $headerSubtitle.textContent = 'é€éé—œéµå­—ç¯©é¸ï¼Œæ‰¾å‡ºä½ æ­£åœ¨å°‹æ‰¾çš„å²©çŸ³æˆ–ç¤¦ç‰©ï¼';
                $headerIcon.setAttribute('data-lucide', 'gem');
                filterGallery();
            } else if (mode === 'quiz') {
                $quizMode.classList.remove('hidden');
                $modeQuizBtn.classList.add('bg-emerald-500', 'text-white', 'border-emerald-500');
                $modeGalleryBtn.classList.add('border-r-0');
                $modeLeaderboardBtn.classList.add('border-l-0');
                $headerTitle.textContent = 'å²©çŸ³èˆ‡ç¤¦ç‰©ç‰¹å¾µæ¸¬é©—';
                $headerSubtitle.textContent = 'æ¸¬è©¦ä½ å°å°ç£å¸¸è¦‹å²©çŸ³èˆ‡ç¤¦ç‰©ã€Œç‰¹å¾µèˆ‡ç”¨é€”ã€çš„èªè­˜ï¼';
                $headerIcon.setAttribute('data-lucide', 'scroll-text');
                showQuizScreen('start-screen');
            } else if (mode === 'leaderboard') { 
                $leaderboardMode.classList.remove('hidden');
                $modeLeaderboardBtn.classList.add('bg-emerald-500', 'text-white', 'border-emerald-500');
                $modeQuizBtn.classList.add('border-r-0');
                $headerTitle.textContent = 'æ¸¬é©—æˆç¸¾æ’è¡Œæ¦œ';
                $headerSubtitle.textContent = 'æŸ¥çœ‹æŒ‘æˆ°æˆæœä¸¦æ¯”è¼ƒæˆç¸¾ï¼';
                $headerIcon.setAttribute('data-lucide', 'trophy');
                renderLeaderboard(); // æ¸²æŸ“æ’è¡Œæ¦œ
            }
            lucide.createIcons();
        }

        /** åœ–é‘‘/æ¸¬é©—é‚è¼¯ (æœªè®Šå‹•å‡½æ•¸) **/

        function renderKeywords() {
            const renderCategory = (container, keywords, type) => {
                container.innerHTML = '';
                const categoryKeywords = KEYWORDS[type] || [];
                categoryKeywords.forEach(kw => {
                    const btn = document.createElement('button');
                    const isSelected = selectedKeywords.has(kw);
                    btn.textContent = kw;
                    btn.className = `keyword-btn ${isSelected ? 'selected' : ''}`;
                    btn.setAttribute('data-keyword', kw);
                    btn.addEventListener('click', () => toggleKeyword(kw, type));
                    container.appendChild(btn);
                });
            };

            renderCategory($colorKeywords, KEYWORDS['é¡è‰²'], 'é¡è‰²');
            renderCategory($featureKeywords, KEYWORDS['ç‰¹å¾µ'], 'ç‰¹å¾µ');
        }

        function toggleKeyword(keyword, type) {
            if (selectedKeywords.has(keyword)) {
                selectedKeywords.delete(keyword);
            } else {
                selectedKeywords.add(keyword);
            }
            renderKeywords();
            filterGallery();
        }

        function filterGallery() {
            const activeKeywords = Array.from(selectedKeywords);
            
            if (activeKeywords.length === 0) {
                $galleryWrapper.classList.add('hidden');
                $filterPrompt.classList.remove('hidden');
                renderGallery([]);
                return;
            }
            
            $galleryWrapper.classList.remove('hidden');
            $filterPrompt.classList.add('hidden');
            
            const filteredMinerals = MINERALS.filter(mineral => {
                return activeKeywords.every(kw => mineral.features.includes(kw));
            });
            
            renderGallery(filteredMinerals);
        }
        
        function renderGallery(minerals) {
            $gallery.innerHTML = '';
            if (minerals.length === 0) {
                if (selectedKeywords.size > 0) {
                    $noResultMsg.classList.remove('hidden');
                } else {
                    $noResultMsg.classList.add('hidden');
                }
                return;
            }
            $noResultMsg.classList.add('hidden');

            minerals.forEach(mineral => {
                const card = document.createElement('div');
                card.className = 'card p-3 flex flex-col items-center text-center hover:bg-gray-50 cursor-pointer transition-colors';
                card.innerHTML = `
                    <div class="w-20 h-20 rounded-lg overflow-hidden mb-2 bg-gray-200 flex items-center justify-center border-2 border-gray-300">
                        <img src="${mineral.imageUrl}" class="w-full h-full object-cover" alt="${mineral.name}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/6b7280/ffffff?text=${mineral.name.slice(0, 2)}';">
                    </div>
                    <p class="font-bold text-lg">${mineral.name}</p>
                    <p class="text-xs text-gray-500">${mineral.type}</p>
                    <button data-mineral-id="${mineral.id}" class="mt-2 text-xs text-blue-500 font-semibold hover:underline flex items-center">
                        <i data-lucide="info" class="w-3 h-3 mr-1"></i>
                        äº†è§£æ›´å¤š
                    </button>
                `;
                card.querySelector('button').addEventListener('click', (e) => showMineralDetail(mineral.id, e));
                $gallery.appendChild(card);
            });
            lucide.createIcons();
        }

        function showMineralDetail(id, event) {
            event.stopPropagation();
            const mineral = MINERALS.find(m => m.id === id);
            if (!mineral) return;
            $modalContent.innerHTML = `
                <button id="close-modal-btn" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 text-gray-500">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
                <div class="flex flex-col sm:flex-row gap-6 items-center">
                    <div class="flex-shrink-0 w-32 h-32 rounded-xl overflow-hidden bg-gray-200 flex items-center justify-center border-4 border-emerald-400">
                        <img src="${mineral.imageUrl}" class="w-full h-full object-cover" alt="${mineral.name}" onerror="this.onerror=null;this.src='https://placehold.co/128x128/6b7280/ffffff?text=${mineral.name.slice(0, 2)}';">
                    </div>
                    <div class="text-center sm:text-left">
                        <h2 class="text-3xl font-extrabold text-gray-800">${mineral.name} <span class="text-xl font-normal text-gray-500">(${mineral.engName})</span></h2>
                        <p class="text-base text-gray-600 mt-1">åˆ†é¡ï¼š${mineral.type} ï½œ ğŸŒ ç”¢åœ°åˆ†ä½ˆï¼š${mineral.habitat || 'ç„¡è³‡æ–™'}</p>
                    </div>
                </div>
                <div class="mt-6 space-y-3">
                    <h3 class="text-xl font-bold text-gray-700 border-b pb-2">ğŸ”¬ ä¸»è¦ç‰¹å¾µ</h3>
                    <p class="text-gray-700"><span class="font-semibold text-emerald-600">é¡è‰²:</span> ${mineral.color.join(', ')}</p>
                    <p class="text-gray-700"><span class="font-semibold text-emerald-600">ç‰¹å¾µ:</span> ${mineral.features.filter(f => !mineral.color.includes(f) && f !== mineral.type).join('ã€')}</p>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <h3 class="text-xl font-bold text-gray-700 mb-2">ğŸ­ ä¸»è¦ç”¨é€”</h3>
                    <p class="text-gray-600">${mineral.usage || 'ç„¡è³‡æ–™'}</p>
                </div>
            `;
            $modal.classList.remove('hidden');
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            lucide.createIcons();
        }

        function closeModal() {
            $modal.classList.add('hidden');
        }

        function showQuizScreen(screenId) {
            $startScreen.classList.add('hidden');
            $quizScreen.classList.add('hidden');
            $resultScreen.classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
        }

        function generateQuizQuestions() {
            const shuffledMinerals = [...MINERALS];
            shuffleArray(shuffledMinerals);
            const selectedMinerals = shuffledMinerals.slice(0, NUM_QUESTIONS);

            const questions = selectedMinerals.map(mineral => {
                const correctOptions = [
                    ...mineral.features, 
                    ...mineral.usage.split('ã€').map(u => u.trim()).filter(u => u.length > 0)
                ];
                const correctAnswer = correctOptions[Math.floor(Math.random() * correctOptions.length)];
                const wrongOptions = allQuizOptions.filter(option => !correctOptions.includes(option));
                shuffleArray(wrongOptions);
                let distractors = wrongOptions.slice(0, 3);
                while (distractors.length < 3) {
                    const filler = wrongOptions[Math.floor(Math.random() * wrongOptions.length)] || 'å…¶ä»–ç‰¹å¾µ';
                    if (!distractors.includes(filler)) {
                        distractors.push(filler);
                    } else if (distractors.length < 2) {
                        distractors.push('ç„¡æ­¤ç‰¹å¾µæˆ–ç”¨é€”');
                    }
                }
                const options = [correctAnswer, ...distractors.slice(0, 3)];
                shuffleArray(options);
                return {
                    mineral,
                    correctAnswer: correctAnswer,
                    options,
                    userSelection: null
                };
            });
            return questions;
        }

        function startGame() {
            const name = $nameInput.value.trim();
            if (name.length < 1) {
                alert('è«‹è¼¸å…¥æ‚¨çš„å§“åæ‰èƒ½é–‹å§‹æ¸¬é©—ï¼');
                return;
            }
            studentName = name;
            currentQuestionIndex = 0;
            userAnswers = [];
            score = 0;
            quizQuestions = generateQuizQuestions();
            $nameDisplay.textContent = studentName;
            showQuizScreen('quiz-screen');
            renderQuestion();
            lucide.createIcons();
        }

        function renderQuestion() {
            const question = quizQuestions[currentQuestionIndex];
            const qNum = currentQuestionIndex + 1;
            $questionHeader.textContent = `ç¬¬ ${qNum}/${NUM_QUESTIONS} é¡Œ`;
            $mineralImage.src = question.mineral.imageUrl;
            $mineralImage.alt = `ç¬¬ ${qNum} é¡Œï¼š${question.mineral.name} çš„åœ–ç‰‡`;
            $optionsContainer.innerHTML = '';
            question.options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                btn.setAttribute('data-answer', option);
                btn.addEventListener('click', () => selectAnswer(option));
                $optionsContainer.appendChild(btn);
            });
            $nextBtn.textContent = (qNum < NUM_QUESTIONS) ? 'ä¸‹ä¸€é¡Œ' : 'é€å‡ºæ¸¬é©—';
            $nextBtn.disabled = true;
            if (question.userSelection) {
                selectAnswer(question.userSelection, false);
            }
        }

        function selectAnswer(selection, update = true) {
            const question = quizQuestions[currentQuestionIndex];
            $optionsContainer.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            const selectedBtn = $optionsContainer.querySelector(`[data-answer="${selection}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
            if (update) {
                question.userSelection = selection;
                $nextBtn.disabled = false;
            }
        }

        function nextQuestion() {
            const question = quizQuestions[currentQuestionIndex];
            if (!question.userSelection) return;
            userAnswers[currentQuestionIndex] = question.userSelection;
            if (currentQuestionIndex < NUM_QUESTIONS - 1) {
                currentQuestionIndex++;
                renderQuestion();
            } else {
                submitQuiz();
            }
        }
        
        // --- æ¸¬é©—å®Œæˆèˆ‡æ’è¡Œæ¦œ ---

        /** è¨ˆç®—åˆ†æ•¸ã€å„²å­˜æˆç¸¾ä¸¦é¡¯ç¤ºçµæœç•«é¢ (å–æ¶ˆè‡ªå‹•è·³è½‰) */
        function submitQuiz() {
            score = 0;
            quizQuestions.forEach(q => {
                if (q.userSelection === q.correctAnswer) {
                    score += 10;
                }
            });
            
            // è‡ªå‹•å„²å­˜æˆç¸¾åˆ° localStorage
            addScore(studentName, score);

            $resultName.textContent = studentName;
            $finalScore.textContent = score;
            
            // æ¸…é™¤ç‰¹æ•ˆå’Œå…‰èŠ’
            $scoreDisplayBox.classList.remove('perfect-score-glow');
            $scoreDisplayBox.querySelectorAll('.confetti-star').forEach(el => el.remove());

            let message = '';
            if (score === 100) {
                message = 'ğŸ‰ æ»¿åˆ†ï¼ä½ æ˜¯å²©çŸ³èˆ‡ç¤¦ç‰©çš„è¶…ç´šå¤§å¸«ï¼é»æ“Šã€ŒæŸ¥çœ‹æ’è¡Œæ¦œã€ç™»è¨˜ä½ çš„å‚²äººæˆç¸¾ï¼';
                // æ‡‰ç”¨æ»¿åˆ†ç‰¹æ•ˆ
                $scoreDisplayBox.classList.add('perfect-score-glow');
                createSparkles($scoreDisplayBox, 20);
            } else if (score >= 70) {
                message = 'ğŸ‘ è¡¨ç¾å¾ˆä¸éŒ¯ï¼ä½ å·²ç¶“æŒæ¡äº†å¤§éƒ¨åˆ†å¸¸è¦‹å²©çŸ³èˆ‡ç¤¦ç‰©çš„è¾¨è­˜æ–¹æ³•ã€‚';
            } else if (score >= 40) {
                message = 'ğŸ¤” é‚„æœ‰é€²æ­¥ç©ºé–“å–”ï¼å»ºè­°å¯ä»¥å›åˆ°åœ–é‘‘é é¢å†è¤‡ç¿’ä¸€æ¬¡ç‰¹å¾µè³‡è¨Šã€‚';
            } else {
                message = 'ğŸ’ª æ²’é—œä¿‚ï¼Œå¤šåŠ ç·´ç¿’ä¸€å®šæœƒé€²æ­¥ï¼åœ°çƒç§‘å­¸çš„å¥§ç§˜ç­‰ä½ ä¾†ç™¼æ˜ã€‚';
            }
            $resultMessage.textContent = message;

            showQuizScreen('result-screen');
        }

        // --- åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½å™¨ ---

        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–æ—¥æœŸ
            const now = new Date();
            $date.textContent = now.toLocaleDateString('zh-TW', {
                year: 'numeric', month: 'long', day: 'numeric', weekday: 'short'
            });

            // åœ–é‘‘æ¨¡å¼äº‹ä»¶
            renderKeywords();
            filterGallery();
            $clearBtn.addEventListener('click', () => {
                selectedKeywords.clear();
                renderKeywords();
                filterGallery();
            });
            $modal.addEventListener('click', (e) => {
                if (e.target === $modal) { closeModal(); }
            });
            $closeModalBtnTop.addEventListener('click', closeModal);


            // æ¸¬é©—æ¨¡å¼äº‹ä»¶
            $startBtn.addEventListener('click', startGame);
            $nextBtn.addEventListener('click', nextQuestion);
            $restartBtn.addEventListener('click', () => {
                $nameInput.value = studentName;
                showQuizScreen('start-screen');
            });
            $nameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { startGame(); }
            });
            
            // æ’è¡Œæ¦œåˆ‡æ›äº‹ä»¶
            $viewLeaderboardBtn.addEventListener('click', () => showAppMode('leaderboard'));
            $modeLeaderboardBtn.addEventListener('click', () => showAppMode('leaderboard')); 
            
            // æ’è¡Œæ¦œæ¸…é™¤äº‹ä»¶
            $clearLeaderboardBtn.addEventListener('click', showClearPasswordModal);
            $cancelClearBtn.addEventListener('click', cancelClear);
            $confirmClearBtn.addEventListener('click', verifyPasswordAndClear);
            $passwordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { verifyPasswordAndClear(); }
            });
            
            // ç”±æ–¼ä¸å†æœ‰æ’åºæŒ‰éˆ•ï¼Œå°‡ renderLeaderboard ç¶å®šåœ¨ mode-change ä¸Šå³å¯

            // æ¨¡å¼åˆ‡æ›äº‹ä»¶
            $modeGalleryBtn.addEventListener('click', () => showAppMode('gallery'));
            $modeQuizBtn.addEventListener('click', () => showAppMode('quiz'));

            // åˆå§‹é¡¯ç¤ºç‚ºåœ–é‘‘æ¨¡å¼
            showAppMode('gallery');
        });
    </script>
</body>

</html>



