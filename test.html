import React, { useState, useEffect } from 'react';
import { Trophy, Play, Trash2, Home, CheckCircle, XCircle, Leaf, ShieldAlert, Award, FileText, Settings, Save, AlertCircle } from 'lucide-react';

// --- 常數定義 ---
const TITLES = [
  { min: 0, name: "初入叢林", color: "text-gray-500" },
  { min: 5, name: "尋路者", color: "text-stone-500" },
  { min: 10, name: "採集學徒", color: "text-stone-600" },
  { min: 15, name: "森林觀察員", color: "text-green-800" },
  { min: 20, name: "溪流旅人", color: "text-blue-400" },
  { min: 25, name: "營地守衛", color: "text-stone-700" },
  { min: 30, name: "追蹤者", color: "text-amber-700" },
  { min: 35, name: "狩獵新手", color: "text-orange-600" },
  { min: 40, name: "叢林斥候", color: "text-lime-600" },
  { min: 45, name: "植物學者", color: "text-green-600" },
  { min: 50, name: "野外求生專家", color: "text-emerald-600" },
  { min: 55, name: "獸徑引路人", color: "text-teal-600" },
  { min: 60, name: "森林遊俠", color: "text-cyan-600" },
  { min: 65, name: "部落長老", color: "text-purple-600" },
  { min: 70, name: "自然祭司", color: "text-violet-600" },
  { min: 75, name: "大地守護者", color: "text-indigo-600" },
  { min: 80, name: "森林之王", color: "text-rose-600" },
  { min: 85, name: "荒野傳奇", color: "text-fuchsia-600" },
  { min: 90, name: "萬物導師", color: "text-yellow-600" },
  { min: 95, name: "自然之神", color: "text-yellow-500 font-bold" },
];

const INITIAL_DATA = [
  { id: 1, question: "地球表面的岩石和土壤是大部分生物生長或活動的環境。", options: ["O", "X"], answer: "O" },
  { id: 2, question: "在野外，到處都看得到由岩石所形成各種地形景觀，不同地方的岩石種類都相同。", options: ["O", "X"], answer: "X" },
  { id: 3, question: "出外旅遊，看到漂亮或喜歡的岩石，都可以敲下來帶回家。", options: ["O", "X"], answer: "X" },
  { id: 4, question: "石灰岩主要是由方解石所組成的。", options: ["O", "X"], answer: "O" },
  { id: 5, question: "花崗岩是由長石、黑雲母或白雲母、石英等礦物所組成的。", options: ["O", "X"], answer: "O" },
];

// --- 輔助：安全存取 LocalStorage ---
const safeGetStorage = (key, defaultVal) => {
  try {
    const item = localStorage.getItem(key);
    return item ? JSON.parse(item) : defaultVal;
  } catch (e) {
    console.warn('Storage access error:', e);
    return defaultVal;
  }
};

const safeSetStorage = (key, val) => {
  try {
    localStorage.setItem(key, JSON.stringify(val));
  } catch (e) {
    console.warn('Storage write error:', e);
  }
};

const safeRemoveStorage = (key) => {
  try {
    localStorage.removeItem(key);
  } catch (e) {
    console.warn('Storage remove error:', e);
  }
};

// --- 子元件定義 (Sub-Components) ---

const HomeView = ({ onStart, onViewTitles, onViewAdmin, count }) => (
  <div className="flex flex-col items-center justify-center min-h-screen p-4 space-y-8 animate-fadeIn">
    <div className="text-center space-y-4">
      <div className="inline-block p-4 bg-green-100 rounded-full mb-4 shadow-inner">
        <Leaf size={64} className="text-green-600" />
      </div>
      <h1 className="text-4xl md:text-5xl font-bold text-green-800 tracking-wider">自然生態大會考</h1>
      <p className="text-lg text-stone-600 font-medium">目前的題庫數量：{count} 題</p>
    </div>
    <div className="flex flex-col gap-4 w-full max-w-md">
      <button onClick={onStart} className="bg-green-600 hover:bg-green-700 text-white py-4 px-6 rounded-xl shadow-lg flex items-center justify-center gap-2 text-xl font-bold transition transform hover:scale-105">
        <Play size={24} /> 開始測驗
      </button>
      <button onClick={onViewTitles} className="bg-amber-600 hover:bg-amber-700 text-white py-4 px-6 rounded-xl shadow-lg flex items-center justify-center gap-2 text-xl font-bold transition transform hover:scale-105">
        <Trophy size={24} /> 稱號圖鑑
      </button>
      <button onClick={onViewAdmin} className="bg-stone-600 hover:bg-stone-700 text-white py-3 px-6 rounded-xl shadow flex items-center justify-center gap-2 font-bold transition">
        <Settings size={20} /> 題庫管理
      </button>
    </div>
  </div>
);

const QuizView = ({ question, index, total, score, feedback, selectedOption, onAnswer, onNext }) => {
  if (!question) return <div className="p-10 text-center">載入中...</div>;
  return (
    <div className="max-w-3xl mx-auto min-h-screen p-4 flex flex-col justify-center animate-fadeIn">
      <div className="w-full bg-stone-200 rounded-full h-4 mb-6 overflow-hidden shadow-inner">
        <div className="bg-green-500 h-4 rounded-full transition-all duration-500 ease-out" style={{ width: `${((index + 1) / total) * 100}%` }}></div>
      </div>
      <div className="flex justify-between items-center mb-4 text-stone-600 font-bold">
        <span>第 {index + 1} / {total} 題</span>
        <span>得分: {score}</span>
      </div>
      <div className="bg-white rounded-2xl shadow-xl p-6 md:p-10 mb-6 border-l-8 border-green-600 min-h-[160px] flex items-center">
        <h2 className="text-xl md:text-2xl font-bold text-gray-800 leading-relaxed">{question.question}</h2>
      </div>
      <div className="grid grid-cols-1 gap-4">
        {question.options.map((opt, idx) => {
          let btnClass = "p-4 rounded-xl text-lg font-medium border-2 transition-all duration-200 shadow-md text-left flex items-center justify-between ";
          if (feedback) {
            if (opt === question.answer) btnClass += "bg-green-100 border-green-500 text-green-800";
            else if (opt === selectedOption && opt !== question.answer) btnClass += "bg-red-100 border-red-500 text-red-800";
            else btnClass += "bg-stone-50 border-stone-200 text-stone-400 opacity-50";
          } else {
            btnClass += "bg-white border-stone-200 hover:border-green-400 hover:bg-green-50 text-stone-700 hover:shadow-lg";
          }
          return (
            <button key={idx} onClick={() => onAnswer(opt)} disabled={feedback !== null} className={btnClass}>
              <span>{opt}</span>
              {feedback && opt === question.answer && <CheckCircle className="text-green-600" />}
              {feedback && opt === selectedOption && opt !== question.answer && <XCircle className="text-red-600" />}
            </button>
          );
        })}
      </div>
      <div className="mt-8 h-20 flex items-center justify-center">
        {feedback && (
          <button onClick={onNext} className="bg-stone-800 text-white px-8 py-3 rounded-xl hover:bg-black transition shadow-lg font-bold text-lg animate-bounceIn">
            {index === total - 1 ? "查看結果" : "下一題"}
          </button>
        )}
      </div>
    </div>
  );
};

const ResultView = ({ score, titleObj, onHome }) => (
  <div className="flex flex-col items-center justify-center min-h-screen p-4 animate-fadeIn">
    <div className="bg-white rounded-3xl shadow-2xl p-8 md:p-12 max-w-lg w-full text-center relative overflow-hidden">
      <div className="absolute top-0 left-0 w-full h-4 bg-gradient-to-r from-green-400 to-blue-500"></div>
      <div className="mb-6 flex justify-center"><Trophy size={80} className="text-yellow-400 drop-shadow-lg" /></div>
      <h2 className="text-3xl font-bold text-stone-800 mb-2">測驗完成</h2>
      <div className="text-6xl font-black text-green-600 mb-4">{score} <span className="text-2xl text-stone-500 font-medium">分</span></div>
      <div className="bg-stone-50 rounded-xl p-4 mb-6">
        <p className="text-stone-500 text-sm uppercase tracking-widest">獲得稱號</p>
        <h3 className={`text-2xl font-bold ${titleObj.color}`}>{titleObj.name}</h3>
      </div>
      <button onClick={onHome} className="w-full bg-stone-700 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-stone-800 transition">
        <Home size={20} /> 返回首頁
      </button>
    </div>
  </div>
);

const TitlesView = ({ history, titles, onDelete, onHome }) => (
  <div className="max-w-4xl mx-auto min-h-screen p-4 md:p-8 animate-fadeIn">
    <div className="flex justify-between items-center mb-8">
      <button onClick={onHome} className="flex items-center gap-2 text-stone-600 hover:text-green-700 font-bold"><Home size={24} /> 返回首頁</button>
      <h2 className="text-2xl md:text-3xl font-bold text-stone-800 flex items-center gap-2"><Award className="text-amber-500" /> 榮譽殿堂</h2>
    </div>
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div className="bg-white rounded-2xl shadow-xl p-6 h-[500px] flex flex-col">
        <div className="flex justify-between items-center mb-4 pb-2 border-b">
          <h3 className="text-xl font-bold text-stone-700">歷史紀錄</h3>
          <button onClick={onDelete} className="text-red-400 hover:text-red-600 text-sm flex gap-1"><Trash2 size={16}/> 刪除</button>
        </div>
        <div className="overflow-y-auto flex-1 space-y-2 custom-scrollbar">
          {history.length === 0 ? <p className="text-center text-stone-400 mt-10">尚無紀錄</p> : 
            history.map((r, i) => (
              <div key={i} className="flex justify-between bg-stone-50 p-3 rounded hover:bg-green-50">
                <div><div className="font-bold text-green-700">{r.title}</div><div className="text-xs text-stone-400">{r.timestamp}</div></div>
                <div className="font-bold text-stone-600">{r.score}分</div>
              </div>
            ))
          }
        </div>
      </div>
      <div className="bg-white/80 rounded-2xl shadow-xl p-6 h-[500px] flex flex-col">
        <h3 className="text-xl font-bold text-stone-700 mb-4 border-b pb-2">稱號列表</h3>
        <div className="overflow-y-auto flex-1 grid grid-cols-1 gap-2 custom-scrollbar">
          {titles.map((t, i) => (
            <div key={i} className="flex items-center gap-3 p-2 hover:bg-white rounded">
              <div className="w-10 h-10 flex items-center justify-center rounded-full bg-stone-100 text-xs text-stone-400">{t.min}+</div>
              <div className={`font-bold ${t.color}`}>{t.name}</div>
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>
);

const AdminView = ({ csvInput, setCsvInput, onParse, onReset, onHome }) => (
  <div className="max-w-4xl mx-auto min-h-screen p-6 animate-fadeIn flex flex-col">
    <div className="flex justify-between items-center mb-6">
      <h2 className="text-3xl font-bold text-stone-800 flex items-center gap-2"><FileText className="text-green-600" /> 匯入題庫 (CSV)</h2>
      <button onClick={onHome} className="flex items-center gap-2 text-stone-600 font-bold hover:text-green-700"><Home size={20} /> 返回</button>
    </div>
    <div className="bg-white p-6 rounded-2xl shadow-xl flex-1 flex flex-col">
      <div className="mb-4 text-stone-600 text-sm bg-blue-50 p-4 rounded-lg border border-blue-100">
        <p className="font-bold mb-2">使用說明：</p>
        <p>1. 複製 Excel/CSV 資料（含標題列）。</p>
        <p>2. 貼上至下方文字框。</p>
        <p>3. 點擊「解析並儲存」。</p>
      </div>
      <textarea className="flex-1 w-full border-2 border-stone-200 rounded-xl p-4 font-mono text-sm focus:border-green-500 focus:outline-none resize-none mb-4"
        placeholder="在此貼上 CSV 內容..." value={csvInput} onChange={(e) => setCsvInput(e.target.value)} />
      <div className="flex gap-4">
        <button onClick={onParse} className="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition flex items-center justify-center gap-2"><Save size={20} /> 解析並儲存</button>
        <button onClick={onReset} className="px-6 border-2 border-red-200 text-red-500 hover:bg-red-50 rounded-xl font-bold transition">恢復預設</button>
      </div>
    </div>
  </div>
);

const MessageModal = ({ isOpen, type, title, message, onConfirm, onClose }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] p-4 animate-fadeIn">
      <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl transform transition-all scale-100">
        <div className="flex items-center gap-2 mb-4">
          {type === 'confirm' ? <AlertCircle className="text-amber-500" /> : <ShieldAlert className="text-blue-500" />}
          <h3 className="text-lg font-bold text-gray-800">{title}</h3>
        </div>
        <p className="text-gray-600 mb-6 whitespace-pre-wrap">{message}</p>
        <div className="flex gap-3 justify-end">
          {type === 'confirm' && <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-bold transition">取消</button>}
          <button onClick={() => { if (onConfirm) onConfirm(); onClose(); }} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold transition">確定</button>
        </div>
      </div>
    </div>
  );
};

// --- 主應用程式元件 ---
export default function NatureQuizApp() {
  const [view, setView] = useState('home');
  const [questionBank, setQuestionBank] = useState(INITIAL_DATA);
  const [currentQuestions, setCurrentQuestions] = useState([]);
  const [currentQIndex, setCurrentQIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [feedback, setFeedback] = useState(null);
  const [selectedOption, setSelectedOption] = useState(null);
  const [titleHistory, setTitleHistory] = useState([]);
  
  const [passwordInput, setPasswordInput] = useState('');
  const [showPasswordModal, setShowPasswordModal] = useState(false);
  const [passwordAction, setPasswordAction] = useState(null); 
  const [csvInput, setCsvInput] = useState('');
  const [msgModal, setMsgModal] = useState({ isOpen: false, type: 'info', title: '', message: '', onConfirm: null });

  useEffect(() => {
    setTitleHistory(safeGetStorage('quizTitleHistory', []));
    const savedBank = safeGetStorage('customQuestionBank', null);
    if (savedBank && savedBank.length > 0) setQuestionBank(savedBank);
  }, []);

  useEffect(() => {
    const preventDefault = (e) => e.preventDefault();
    document.addEventListener('contextmenu', preventDefault);
    document.addEventListener('selectstart', preventDefault);
    return () => {
      document.removeEventListener('contextmenu', preventDefault);
      document.removeEventListener('selectstart', preventDefault);
    };
  }, []);

  const showAlert = (message, title = "提示") => setMsgModal({ isOpen: true, type: 'info', title, message, onConfirm: null });
  const showConfirm = (message, onConfirm, title = "確認") => setMsgModal({ isOpen: true, type: 'confirm', title, message, onConfirm });
  const closeMsgModal = () => setMsgModal(prev => ({ ...prev, isOpen: false }));

  const startQuiz = () => {
    const bank = questionBank.length > 0 ? questionBank : INITIAL_DATA;
    const shuffled = [...bank].sort(() => 0.5 - Math.random());
    setCurrentQuestions(shuffled.slice(0, 20));
    setCurrentQIndex(0);
    setScore(0);
    setFeedback(null);
    setSelectedOption(null);
    setView('quiz');
  };

  const handleAnswer = (option) => {
    if (feedback !== null) return;
    const isCorrect = option === currentQuestions[currentQIndex].answer;
    setSelectedOption(option);
    if (isCorrect) {
      setScore(prev => prev + 5);
      setFeedback('correct');
    } else {
      setFeedback('wrong');
    }
  };

  const nextQuestion = () => {
    if (currentQIndex < currentQuestions.length - 1) {
      setCurrentQIndex(prev => prev + 1);
      setFeedback(null);
      setSelectedOption(null);
    } else {
      // 結束測驗，立即儲存
      const finalScore = score + (feedback === 'correct' ? 0 : 0); // score already updated
      // 注意：這裡 score 是 state，可能還沒更新最後一題的分數嗎？
      // handleAnswer 中 setScore 是 async。
      // 當使用者按「下一題」時，handleAnswer 早就跑完了，所以 score 應該是準確的。
      // 唯獨「最後一題答完顯示結果」的按鈕，我們需確保。
      // 上面 render 中，最後一題顯示的是 "查看結果"，點擊觸發 nextQuestion。
      // 此時 score 已經包含了最後一題的分數（如果答對）。
      
      const titleObj = [...TITLES].reverse().find(t => score >= t.min) || TITLES[0];
      const newRecord = {
        title: titleObj.name,
        score: score,
        timestamp: new Date().toLocaleString('zh-TW', { hour12: false })
      };
      const newHistory = [newRecord, ...titleHistory];
      setTitleHistory(newHistory);
      safeSetStorage('quizTitleHistory', newHistory);
      setView('result');
    }
  };

  const handlePasswordSubmit = () => {
    if (passwordInput === "7772041") {
      if (passwordAction === 'deleteHistory') {
        safeRemoveStorage('quizTitleHistory');
        setTitleHistory([]);
        showAlert("歷史紀錄已成功刪除。");
      } else if (passwordAction === 'enterAdmin') {
        setView('admin');
      }
      setShowPasswordModal(false);
      setPasswordInput('');
    } else {
      showAlert("密碼錯誤！", "驗證失敗");
    }
  };

  const parseAndSaveCSV = () => {
    if (!csvInput.trim()) { showAlert("請輸入 CSV 內容！"); return; }
    try {
      const rows = csvInput.trim().split('\n');
      const newQuestions = [];
      let idCounter = 1;
      rows.forEach((row) => {
        const cleanRow = row.replace(/\r/g, '');
        const cols = cleanRow.split(',').map(c => c.trim());
        // 檢查: 題幹在 index 3, 且排除表頭
        if (cols.length < 5 || !cols[3] || cols[3] === '題幹') return;

        const questionText = cols[3];
        const correctIndex = parseInt(cols[4]); 
        const rawOptions = [cols[5], cols[6], cols[7], cols[8]];
        const options = rawOptions.filter(opt => opt && opt !== '');

        if (options.length >= 2 && !isNaN(correctIndex) && correctIndex <= options.length) {
          newQuestions.push({
            id: idCounter++,
            question: questionText,
            options: options,
            answer: rawOptions[correctIndex - 1]
          });
        }
      });

      if (newQuestions.length > 0) {
        setQuestionBank(newQuestions);
        safeSetStorage('customQuestionBank', newQuestions);
        showAlert(`成功匯入 ${newQuestions.length} 題！`);
        setCsvInput('');
        setView('home');
      } else {
        showAlert("解析失敗，找不到有效題目。\n請確保第4欄是題目，第5欄是答案代號(1-4)。");
      }
    } catch (e) {
      showAlert("發生錯誤：" + e.message);
    }
  };

  return (
    <div className="min-h-screen bg-[#F3F6F1] select-none font-sans text-stone-800 relative">
      <style>{`
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 10px; }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes bounceIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-bounceIn { animation: bounceIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
      `}</style>

      {view === 'home' && <HomeView onStart={startQuiz} onViewTitles={() => setView('titles')} onViewAdmin={() => { setPasswordAction('enterAdmin'); setShowPasswordModal(true); }} count={questionBank.length} />}
      
      {view === 'quiz' && <QuizView question={currentQuestions[currentQIndex]} index={currentQIndex} total={currentQuestions.length} score={score} feedback={feedback} selectedOption={selectedOption} onAnswer={handleAnswer} onNext={nextQuestion} />}
      
      {view === 'result' && <ResultView score={score} titleObj={[...TITLES].reverse().find(t => score >= t.min) || TITLES[0]} onHome={() => setView('home')} />}
      
      {view === 'titles' && <TitlesView history={titleHistory} titles={TITLES} onDelete={() => { setPasswordAction('deleteHistory'); setShowPasswordModal(true); }} onHome={() => setView('home')} />}
      
      {view === 'admin' && <AdminView csvInput={csvInput} setCsvInput={setCsvInput} onParse={parseAndSaveCSV} onReset={() => showConfirm("確定恢復預設題庫？自訂題庫將清空。", () => { setQuestionBank(INITIAL_DATA); safeRemoveStorage('customQuestionBank'); showAlert("已重置"); })} onHome={() => setView('home')} />}

      <MessageModal isOpen={msgModal.isOpen} type={msgModal.type} title={msgModal.title} message={msgModal.message} onConfirm={msgModal.onConfirm} onClose={closeMsgModal} />

      {showPasswordModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-bounceIn">
            <div className="flex items-center gap-2 text-red-600 font-bold mb-4"><ShieldAlert /> 安全驗證</div>
            <p className="text-stone-600 mb-4">請輸入密碼以繼續操作。</p>
            <input type="password" value={passwordInput} onChange={(e) => setPasswordInput(e.target.value)} className="w-full border-2 border-stone-200 rounded-lg p-3 mb-4 focus:outline-none focus:border-red-400" placeholder="請輸入密碼" />
            <div className="flex gap-3">
              <button onClick={() => { setShowPasswordModal(false); setPasswordInput(''); }} className="flex-1 py-2 bg-stone-200 rounded-lg font-bold">取消</button>
              <button onClick={handlePasswordSubmit} className="flex-1 py-2 bg-red-500 text-white rounded-lg font-bold">確認</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
