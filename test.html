import React, { useState, useEffect, useCallback } from 'react';
import { Trophy, History, Play, Trash2, Home, CheckCircle, XCircle, Leaf, ShieldAlert, Award, Upload, FileText, Settings, Save } from 'lucide-react';

// --- 稱號系統配置 (20個等級) ---
const TITLES = [
  { min: 0, name: "初入叢林", color: "text-gray-500" },
  { min: 5, name: "尋路者", color: "text-stone-500" },
  { min: 10, name: "採集學徒", color: "text-stone-600" },
  { min: 15, name: "森林觀察員", color: "text-green-800" },
  { min: 20, name: "溪流旅人", color: "text-blue-400" },
  { min: 25, name: "營地守衛", color: "text-stone-700" },
  { min: 30, name: "追蹤者", color: "text-amber-700" },
  { min: 35, name: "狩獵新手", color: "text-orange-600" },
  { min: 40, name: "叢林斥候", color: "text-lime-600" },
  { min: 45, name: "植物學者", color: "text-green-600" },
  { min: 50, name: "野外求生專家", color: "text-emerald-600" },
  { min: 55, name: "獸徑引路人", color: "text-teal-600" },
  { min: 60, name: "森林遊俠", color: "text-cyan-600" },
  { min: 65, name: "部落長老", color: "text-purple-600" },
  { min: 70, name: "自然祭司", color: "text-violet-600" },
  { min: 75, name: "大地守護者", color: "text-indigo-600" },
  { min: 80, name: "森林之王", color: "text-rose-600" },
  { min: 85, name: "荒野傳奇", color: "text-fuchsia-600" },
  { min: 90, name: "萬物導師", color: "text-yellow-600" },
  { min: 95, name: "自然之神", color: "text-yellow-500 font-bold" },
];

// --- 預設題庫 (從使用者提供的 CSV 片段解析) ---
const INITIAL_DATA = [
  { id: 1, question: "地球表面的岩石和土壤是大部分生物生長或活動的環境。", options: ["O", "X"], answer: "O" },
  { id: 2, question: "在野外，到處都看得到由岩石所形成各種地形景觀，不同地方的岩石種類都相同。", options: ["O", "X"], answer: "X" },
  { id: 3, question: "出外旅遊，看到漂亮或喜歡的岩石，都可以敲下來帶回家。", options: ["O", "X"], answer: "X" },
  { id: 4, question: "石灰岩主要是由方解石所組成的。", options: ["O", "X"], answer: "O" },
  { id: 5, question: "花崗岩是由長石、黑雲母或白雲母、石英等礦物所組成的。", options: ["O", "X"], answer: "O" },
  { id: 6, question: "花崗岩上看起來有點透明的部分是石英。", options: ["O", "X"], answer: "O" },
  { id: 7, question: "花崗岩是由石英一種礦物所組成的。", options: ["O", "X"], answer: "X" },
  { id: 8, question: "沉積岩中的頁岩是由長石、黑雲母或白雲母、石英等礦物所組成的。", options: ["O", "X"], answer: "X" },
  { id: 9, question: "依據岩石的成因，可以把岩石分成火成岩、變質岩、沉積岩三大類。", options: ["O", "X"], answer: "O" },
  { id: 10, question: "科學家依據岩石形成的地點，可以把岩石分成火成岩、沉積岩兩大類。", options: ["O", "X"], answer: "X" },
  { id: 11, question: "火成岩中常見的岩石有安山岩、花崗岩、玄武岩等。", options: ["O", "X"], answer: "O" },
  { id: 12, question: "「老梅綠石槽、鯨魚洞、九棚大沙漠、墾丁沙灘」，以上有幾個景點是由海浪的侵蝕作用所形成的？", options: ["1個", "2個", "3個", "4個"], answer: "2個" },
  { id: 13, question: "「流水、風、波浪、生物活動」，以上有幾項會對地貌造成影響？", options: ["1項", "2項", "3項", "4項"], answer: "4項" },
  { id: 14, question: "關於海蝕溝的敘述，下列何者正確？", options: ["只和海水的搬運作用有關係", "老梅綠石槽屬於這種類型的地形", "成因和海浪沖刷岩石時，會留下較柔軟的部分有關", "是強風將河口的沙吹到岸邊堆積所形成的"], answer: "老梅綠石槽屬於這種類型的地形" },
  { id: 15, question: "臺灣具有什麼特性，導致發生天然災害時，災情往往十分嚴重？", options: ["地質堅硬", "蓄水量充足", "山高水急", "土地開發度低"], answer: "山高水急" },
  { id: 16, question: "下列哪一個是臺灣較常遇到的天然災害？", options: ["寒流", "颱風", "山崩", "水災"], answer: "颱風" },
  { id: 17, question: "下列哪一項不是山崩包含的部分？", options: ["乾旱", "地滑", "落石", "土石流"], answer: "乾旱" }
];

export default function NatureQuizApp() {
  const [view, setView] = useState('home'); // home, quiz, result, titles, admin
  const [questionBank, setQuestionBank] = useState(INITIAL_DATA);
  const [currentQuestions, setCurrentQuestions] = useState([]);
  const [currentQIndex, setCurrentQIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [feedback, setFeedback] = useState(null);
  const [selectedOption, setSelectedOption] = useState(null);
  const [titleHistory, setTitleHistory] = useState([]);
  const [passwordInput, setPasswordInput] = useState('');
  const [showPasswordModal, setShowPasswordModal] = useState(false);
  const [passwordAction, setPasswordAction] = useState(null); // 'deleteHistory' or 'enterAdmin'
  const [csvInput, setCsvInput] = useState('');

  // 初始化：讀取歷史紀錄與自訂題庫
  useEffect(() => {
    const savedHistory = localStorage.getItem('quizTitleHistory');
    if (savedHistory) setTitleHistory(JSON.parse(savedHistory));

    const savedBank = localStorage.getItem('customQuestionBank');
    if (savedBank) {
      setQuestionBank(JSON.parse(savedBank));
    }
  }, []);

  // 防作弊
  useEffect(() => {
    const preventDefault = (e) => e.preventDefault();
    document.addEventListener('contextmenu', preventDefault);
    document.addEventListener('selectstart', preventDefault);
    return () => {
      document.removeEventListener('contextmenu', preventDefault);
      document.removeEventListener('selectstart', preventDefault);
    };
  }, []);

  // --- 邏輯函數 ---

  const startQuiz = () => {
    // 確保題庫足夠
    const bank = questionBank.length > 0 ? questionBank : INITIAL_DATA;
    const shuffled = [...bank].sort(() => 0.5 - Math.random());
    // 如果題庫少於20題，就取全部，否則取20題
    const selected = shuffled.slice(0, 20);
    setCurrentQuestions(selected);
    setCurrentQIndex(0);
    setScore(0);
    setFeedback(null);
    setSelectedOption(null);
    setView('quiz');
  };

  const handleAnswer = (option) => {
    if (feedback !== null) return;
    const isCorrect = option === currentQuestions[currentQIndex].answer;
    setSelectedOption(option);
    if (isCorrect) {
      setScore(prev => prev + 5);
      setFeedback('correct');
    } else {
      setFeedback('wrong');
    }
  };

  const nextQuestion = () => {
    if (currentQIndex < currentQuestions.length - 1) {
      setCurrentQIndex(prev => prev + 1);
      setFeedback(null);
      setSelectedOption(null);
    } else {
      setView('result');
    }
  };

  const getTitleObj = (currentScore) => {
    return [...TITLES].reverse().find(t => currentScore >= t.min) || TITLES[0];
  };

  const saveTitleRecord = useCallback((finalScore) => {
    const titleObj = getTitleObj(finalScore);
    const newRecord = {
      title: titleObj.name,
      score: finalScore,
      timestamp: new Date().toLocaleString('zh-TW', { hour12: false })
    };
    const newHistory = [newRecord, ...titleHistory];
    setTitleHistory(newHistory);
    localStorage.setItem('quizTitleHistory', JSON.stringify(newHistory));
  }, [titleHistory]);

  const handlePasswordSubmit = () => {
    if (passwordInput === "7772041") {
      if (passwordAction === 'deleteHistory') {
        localStorage.removeItem('quizTitleHistory');
        setTitleHistory([]);
        alert("歷史紀錄已刪除。");
      } else if (passwordAction === 'enterAdmin') {
        setView('admin');
      }
      setShowPasswordModal(false);
      setPasswordInput('');
    } else {
      alert("密碼錯誤！");
    }
  };

  // CSV 解析邏輯
  const parseAndSaveCSV = () => {
    try {
      const rows = csvInput.trim().split('\n');
      const newQuestions = [];
      let idCounter = 1;

      rows.forEach((row, index) => {
        // 簡單的 CSV 解析：假設沒有包含逗號的引號內容
        // 格式: 作者,分數,秒數,題幹,正選,選項一,選項二,選項三,選項四
        const cols = row.split(',').map(c => c.trim());
        
        // 跳過標題列或無效列 (檢查題幹是否存在)
        if (cols.length < 5 || !cols[3] || cols[3] === '題幹') return;

        const questionText = cols[3];
        const correctIndex = parseInt(cols[4]); // 1-based index
        
        // 收集選項 (過濾掉空白的選項，例如是非題只有兩個)
        const rawOptions = [cols[5], cols[6], cols[7], cols[8]];
        const options = rawOptions.filter(opt => opt && opt !== '');

        // 確保有選項且正確答案索引有效
        if (options.length >= 2 && !isNaN(correctIndex) && correctIndex <= options.length) {
          const correctVal = rawOptions[correctIndex - 1]; // 取得正確答案文字
          
          newQuestions.push({
            id: idCounter++,
            question: questionText,
            options: options,
            answer: correctVal
          });
        }
      });

      if (newQuestions.length > 0) {
        setQuestionBank(newQuestions);
        localStorage.setItem('customQuestionBank', JSON.stringify(newQuestions));
        alert(`成功匯入 ${newQuestions.length} 題！`);
        setView('home');
      } else {
        alert("解析失敗，未找到有效題目。請檢查格式。");
      }
    } catch (e) {
      alert("發生錯誤：" + e.message);
    }
  };

  // --- 畫面元件 ---

  const renderHome = () => (
    <div className="flex flex-col items-center justify-center min-h-screen p-4 space-y-8 animate-fadeIn">
      <div className="text-center space-y-4">
        <div className="inline-block p-4 bg-green-100 rounded-full mb-4 shadow-inner">
          <Leaf size={64} className="text-green-600" />
        </div>
        <h1 className="text-4xl md:text-5xl font-bold text-green-800 tracking-wider">自然生態大會考</h1>
        <p className="text-lg text-stone-600 font-medium">目前的題庫數量：{questionBank.length} 題</p>
      </div>
      
      <div className="flex flex-col gap-4 w-full max-w-md">
        <button onClick={startQuiz} className="bg-green-600 hover:bg-green-700 text-white py-4 px-6 rounded-xl shadow-lg flex items-center justify-center gap-2 text-xl font-bold transition transform hover:scale-105">
          <Play size={24} /> 開始測驗
        </button>
        <button onClick={() => setView('titles')} className="bg-amber-600 hover:bg-amber-700 text-white py-4 px-6 rounded-xl shadow-lg flex items-center justify-center gap-2 text-xl font-bold transition transform hover:scale-105">
          <Trophy size={24} /> 稱號圖鑑
        </button>
        <button 
          onClick={() => { setPasswordAction('enterAdmin'); setShowPasswordModal(true); }}
          className="bg-stone-600 hover:bg-stone-700 text-white py-3 px-6 rounded-xl shadow flex items-center justify-center gap-2 font-bold transition"
        >
          <Settings size={20} /> 題庫管理 (需密碼)
        </button>
      </div>
    </div>
  );

  const renderAdmin = () => (
    <div className="max-w-4xl mx-auto min-h-screen p-6 animate-fadeIn flex flex-col">
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-3xl font-bold text-stone-800 flex items-center gap-2">
          <FileText className="text-green-600" /> 匯入題庫 (CSV)
        </h2>
        <button onClick={() => setView('home')} className="flex items-center gap-2 text-stone-600 font-bold hover:text-green-700">
          <Home size={20} /> 返回
        </button>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-xl flex-1 flex flex-col">
        <div className="mb-4 text-stone-600 text-sm bg-blue-50 p-4 rounded-lg border border-blue-100">
          <p className="font-bold mb-2">使用說明：</p>
          <p>1. 請開啟您的 CSV 檔案 (Excel)。</p>
          <p>2. 複製所有內容 (包含標題列: 作者,分數,秒數,題幹,正選,選項一...)。</p>
          <p>3. 貼上到下方的文字框中。</p>
          <p>4. 點擊「解析並儲存」。</p>
          <p className="mt-2 text-blue-600">格式要求：第4欄為題目，第5欄為正確答案代號(1,2,3,4)，第6-9欄為選項。</p>
        </div>

        <textarea 
          className="flex-1 w-full border-2 border-stone-200 rounded-xl p-4 font-mono text-sm focus:border-green-500 focus:outline-none resize-none mb-4"
          placeholder="在此貼上 CSV 內容..."
          value={csvInput}
          onChange={(e) => setCsvInput(e.target.value)}
        />

        <div className="flex gap-4">
          <button 
            onClick={parseAndSaveCSV}
            className="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition flex items-center justify-center gap-2"
          >
            <Save size={20} /> 解析並儲存 ({csvInput.split('\n').length > 1 ? csvInput.split('\n').length - 1 : 0} 行)
          </button>
          <button 
            onClick={() => {
              if (confirm("確定要恢復預設題庫嗎？這將清除您匯入的資料。")) {
                setQuestionBank(INITIAL_DATA);
                localStorage.removeItem('customQuestionBank');
                alert("已恢復預設題庫");
              }
            }}
            className="px-6 border-2 border-red-200 text-red-500 hover:bg-red-50 rounded-xl font-bold transition"
          >
            恢復預設
          </button>
        </div>
      </div>
    </div>
  );

  const renderQuiz = () => {
    const question = currentQuestions[currentQIndex];
    if (!question) return <div>載入中...</div>;

    return (
      <div className="max-w-3xl mx-auto min-h-screen p-4 flex flex-col justify-center animate-fadeIn">
        <div className="w-full bg-stone-200 rounded-full h-4 mb-6 overflow-hidden shadow-inner">
          <div 
            className="bg-green-500 h-4 rounded-full transition-all duration-500 ease-out"
            style={{ width: `${((currentQIndex + 1) / currentQuestions.length) * 100}%` }}
          ></div>
        </div>
        
        <div className="flex justify-between items-center mb-4 text-stone-600 font-bold">
          <span>第 {currentQIndex + 1} / {currentQuestions.length} 題</span>
          <span>得分: {score}</span>
        </div>

        <div className="bg-white rounded-2xl shadow-xl p-6 md:p-10 mb-6 border-l-8 border-green-600 min-h-[160px] flex items-center">
          <h2 className="text-xl md:text-2xl font-bold text-gray-800 leading-relaxed">
            {question.question}
          </h2>
        </div>

        <div className="grid grid-cols-1 gap-4">
          {question.options.map((opt, idx) => {
            let btnClass = "p-4 rounded-xl text-lg font-medium border-2 transition-all duration-200 shadow-md text-left flex items-center justify-between ";
            
            if (feedback) {
              if (opt === question.answer) {
                btnClass += "bg-green-100 border-green-500 text-green-800";
              } else if (opt === selectedOption && opt !== question.answer) {
                btnClass += "bg-red-100 border-red-500 text-red-800";
              } else {
                btnClass += "bg-stone-50 border-stone-200 text-stone-400 opacity-50";
              }
            } else {
              btnClass += "bg-white border-stone-200 hover:border-green-400 hover:bg-green-50 text-stone-700 hover:shadow-lg";
            }

            return (
              <button 
                key={idx} 
                onClick={() => handleAnswer(opt)}
                disabled={feedback !== null}
                className={btnClass}
              >
                <span>{opt}</span>
                {feedback && opt === question.answer && <CheckCircle className="text-green-600" />}
                {feedback && opt === selectedOption && opt !== question.answer && <XCircle className="text-red-600" />}
              </button>
            );
          })}
        </div>

        <div className="mt-8 h-20 flex items-center justify-center">
          {feedback && (
            <button 
              onClick={nextQuestion}
              className="bg-stone-800 text-white px-8 py-3 rounded-xl hover:bg-black transition shadow-lg font-bold text-lg animate-bounceIn"
            >
              {currentQIndex === currentQuestions.length - 1 ? "查看結果" : "下一題"}
            </button>
          )}
        </div>
      </div>
    );
  };

  const ResultView = () => {
    useEffect(() => { saveTitleRecord(score); }, []);
    const titleObj = getTitleObj(score);

    return (
      <div className="flex flex-col items-center justify-center min-h-screen p-4 animate-fadeIn">
        <div className="bg-white rounded-3xl shadow-2xl p-8 md:p-12 max-w-lg w-full text-center relative overflow-hidden">
          <div className="absolute top-0 left-0 w-full h-4 bg-gradient-to-r from-green-400 to-blue-500"></div>
          <div className="mb-6 flex justify-center">
             <Trophy size={80} className="text-yellow-400 drop-shadow-lg" />
          </div>
          <h2 className="text-3xl font-bold text-stone-800 mb-2">測驗完成</h2>
          <div className="text-6xl font-black text-green-600 mb-4">{score} <span className="text-2xl text-stone-500 font-medium">分</span></div>
          <div className="bg-stone-50 rounded-xl p-4 mb-6">
            <p className="text-stone-500 text-sm uppercase tracking-widest">獲得稱號</p>
            <h3 className={`text-2xl font-bold ${titleObj.color}`}>{titleObj.name}</h3>
          </div>
          <button onClick={() => setView('home')} className="w-full bg-stone-700 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-stone-800 transition">
            <Home size={20} /> 返回首頁
          </button>
        </div>
      </div>
    );
  };

  const renderTitles = () => (
    <div className="max-w-4xl mx-auto min-h-screen p-4 md:p-8 animate-fadeIn">
      <div className="flex justify-between items-center mb-8">
        <button onClick={() => setView('home')} className="flex items-center gap-2 text-stone-600 hover:text-green-700 font-bold">
          <Home size={24} /> 返回首頁
        </button>
        <h2 className="text-2xl md:text-3xl font-bold text-stone-800 flex items-center gap-2"><Award className="text-amber-500" /> 榮譽殿堂</h2>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div className="bg-white rounded-2xl shadow-xl p-6 h-[500px] flex flex-col">
          <div className="flex justify-between items-center mb-4 pb-2 border-b">
            <h3 className="text-xl font-bold text-stone-700">歷史紀錄</h3>
            <button onClick={() => { setPasswordAction('deleteHistory'); setShowPasswordModal(true); }} className="text-red-400 hover:text-red-600 text-sm flex gap-1"><Trash2 size={16}/> 刪除</button>
          </div>
          <div className="overflow-y-auto flex-1 space-y-2 custom-scrollbar">
            {titleHistory.length === 0 ? <p className="text-center text-stone-400 mt-10">尚無紀錄</p> : 
              titleHistory.map((r, i) => (
                <div key={i} className="flex justify-between bg-stone-50 p-3 rounded hover:bg-green-50">
                  <div><div className="font-bold text-green-700">{r.title}</div><div className="text-xs text-stone-400">{r.timestamp}</div></div>
                  <div className="font-bold text-stone-600">{r.score}分</div>
                </div>
              ))
            }
          </div>
        </div>

        <div className="bg-white/80 rounded-2xl shadow-xl p-6 h-[500px] flex flex-col">
          <h3 className="text-xl font-bold text-stone-700 mb-4 border-b pb-2">稱號列表</h3>
          <div className="overflow-y-auto flex-1 grid grid-cols-1 gap-2 custom-scrollbar">
            {TITLES.map((t, i) => (
              <div key={i} className="flex items-center gap-3 p-2 hover:bg-white rounded">
                <div className="w-10 h-10 flex items-center justify-center rounded-full bg-stone-100 text-xs text-stone-400">{t.min}+</div>
                <div className={`font-bold ${t.color}`}>{t.name}</div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-[#F3F6F1] select-none font-sans text-stone-800">
      <style>{`
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 10px; }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes bounceIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-bounceIn { animation: bounceIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
      `}</style>
      
      {view === 'home' && renderHome()}
      {view === 'quiz' && renderQuiz()}
      {view === 'result' && <ResultView />}
      {view === 'titles' && renderTitles()}
      {view === 'admin' && renderAdmin()}

      {showPasswordModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-bounceIn">
            <div className="flex items-center gap-2 text-red-600 font-bold mb-4"><ShieldAlert /> 安全驗證</div>
            <p className="text-stone-600 mb-4">請輸入密碼以繼續操作。</p>
            <input 
              type="password" 
              value={passwordInput} 
              onChange={(e) => setPasswordInput(e.target.value)} 
              className="w-full border-2 border-stone-200 rounded-lg p-3 mb-4 focus:outline-none focus:border-red-400" 
              placeholder="請輸入密碼" 
            />
            <div className="flex gap-3">
              <button onClick={() => { setShowPasswordModal(false); setPasswordInput(''); }} className="flex-1 py-2 bg-stone-200 rounded-lg font-bold">取消</button>
              <button onClick={handlePasswordSubmit} className="flex-1 py-2 bg-red-500 text-white rounded-lg font-bold">確認</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}